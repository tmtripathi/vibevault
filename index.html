<!DOCTYPE html>
<!--
    VibeVault V4.0.2 - Personal Diary & Mood Tracker
    Created by Jiya
    
    This is a SAFE HTML file - it contains only client-side JavaScript for a personal diary app.
    There is NO server communication, NO malware, NO viruses.
    All data stays in your browser's local storage.
    
    Gmail may flag large HTML files with JavaScript as potentially unsafe, but this file is 100% safe.
    You can open it in any browser and all your data will be private and local.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JiyaZee VibeVault</title>
    
    <!-- PWA Support -->
    <meta name="theme-color" content="#818cf8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VibeVault">

    <script>
        (function() {
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#818cf8"/><stop offset="100%" stop-color="#f472b6"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="url(#g)" stroke="white" stroke-width="3"/><path d="M80 25 L82 30 L87 32 L82 34 L80 39 L78 34 L73 32 L78 30 Z" fill="#fef08a"/><text x="50" y="65" font-size="42" font-weight="800" fill="white" text-anchor="middle" font-family="sans-serif">JZ</text></svg>`;
            const iconUrl = "data:image/svg+xml;base64," + btoa(iconSvg);
            const manifest = {
                "name": "JiyaZee VibeVault - Personal Diary",
                "short_name": "VibeVault",
                "description": "Track your moods, emotions, and vibes throughout the year",
                "start_url": "./",
                "scope": "./",
                "display": "standalone",
                "display_override": ["standalone", "fullscreen"],
                "background_color": "#ffffff",
                "theme_color": "#818cf8",
                "orientation": "portrait-primary",
                "categories": ["lifestyle", "health", "productivity"],
                "icons": [
                    { "src": iconUrl, "sizes": "72x72", "type": "image/svg+xml", "purpose": "any" },
                    { "src": iconUrl, "sizes": "96x96", "type": "image/svg+xml", "purpose": "any" },
                    { "src": iconUrl, "sizes": "128x128", "type": "image/svg+xml", "purpose": "any" },
                    { "src": iconUrl, "sizes": "144x144", "type": "image/svg+xml", "purpose": "any" },
                    { "src": iconUrl, "sizes": "152x152", "type": "image/svg+xml", "purpose": "any" },
                    { "src": iconUrl, "sizes": "192x192", "type": "image/svg+xml", "purpose": "any maskable" },
                    { "src": iconUrl, "sizes": "384x384", "type": "image/svg+xml", "purpose": "any" },
                    { "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml", "purpose": "any maskable" }
                ]
            };
            const link = (rel, href) => { const l = document.createElement('link'); l.rel = rel; l.href = href; document.head.appendChild(l); };
            link('manifest', 'data:application/manifest+json;base64,' + btoa(JSON.stringify(manifest)));
            link('icon', iconUrl);
            link('apple-touch-icon', iconUrl);

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    const swCode = `
                        const CACHE_NAME = 'vibevault-v1';
                        self.addEventListener('install', (event) => {
                            event.waitUntil(caches.open(CACHE_NAME));
                        });
                        self.addEventListener('fetch', (event) => {
                            event.respondWith(
                                caches.match(event.request).then((response) => response || fetch(event.request))
                            );
                        });
                    `;
                    const blob = new Blob([swCode], {type: 'text/javascript'});
                    const swUrl = URL.createObjectURL(blob);
                    navigator.serviceWorker.register(swUrl)
                        .then(reg => console.log('SW registered'))
                        .catch(e => console.log('SW failed:', e));
                });
            }

            // PWA Install Prompt Handler
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                window.showInstallPromotion = true;
            });

            window.installPWA = async () => {
                if (!deferredPrompt) {
                    alert('To install: Tap Chrome menu (â‹®) â†’ "Add to Home Screen"');
                    return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                window.showInstallPromotion = false;
            };
        })();
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Inter:wght@300..700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS & JS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        .animate-pulse-mic { animation: pulseMic 1.5s infinite; }
        .animate-pulse-loading { animation: pulseLoading 1.5s ease-in-out infinite; }
        .highlight-positive { background-color: #bbf7d0; color: #166534; padding: 0 2px; border-radius: 2px; }
        .highlight-negative { background-color: #fecaca; color: #991b1b; padding: 0 2px; border-radius: 2px; }
        
        /* Mobile touch improvements */
        * { -webkit-tap-highlight-color: transparent; }
        button, [role="button"] { touch-action: manipulation; }
        .touch-pan-x { touch-action: pan-x; }
        .touch-pan-y { touch-action: pan-y; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        @keyframes pulseMic { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes pulseLoading { 0% { width: 20%; opacity: 0.6; } 50% { width: 80%; opacity: 1; } 100% { width: 20%; opacity: 0.6; } }
        .font-playful { font-family: 'Fredoka', sans-serif; }
        .font-professional { font-family: 'Inter', sans-serif; }
        .leaflet-container { z-index: 0; border-radius: 1rem; height: 400px !important; min-height: 400px !important; }
        .map-container { height: 400px !important; min-height: 400px !important; width: 100%; position: relative; }
        canvas { max-width: 100%; }
        * { transition: opacity 0.15s ease; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // --- DATA & CONFIG ---
        const TRANSLATIONS = {
            en: {
                welcome: "Welcome!", setupTitle: "Profile & Settings", nameLabel: "What's your name?", ageLabel: "How old are you?", locationLabel: "Your Location", languageLabel: "Preferred Language",
                omdbLabel: "OMDb API Key (Movies)", omdbHint: "Default provided. Or use your own from omdbapi.com", detectLoc: "Detect", uploadPhoto: "Upload Photo",
                letsGo: "Let's Go! ðŸš€", save: "Save Profile", resetApp: "Reset App", resetConfirm: "Are you sure? This will delete ALL your data.",
                hello: "Hello", yearProgress: "Year Progress", dailyStatus: "Daily Vibe Check", missing: "You haven't tracked:",
                allCaughtUp: "ðŸŽ‰ You are all caught up for today! Amazing!", resetPage: "Reset Page", resetPageConfirm: "Clear all data on this page?",
                legend: "Legend", months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                week: "Week", listening: "Listening...", clickDictate: "Click to Dictate", clickMagic: "Search & Add",
                addEntry: "Add an entry...", customizeTitle: "Customize Tracker Labels", customizeDesc: "Tap to rename any emotion or rating",
                trending: "Trending Near You", addToMonth: "Add to Current Month", help: "Help Guide", helpTitle: "âœ¨ Feature Guide âœ¨",
                forecast: "10-Day Forecast", autoFill: "Auto-Fill History", autoFillConfirm: "This will fetch past weather data for your location and fill any empty days for this year. Continue?",
                dataMgmt: "Data Management", exportData: "Export Data (JSON)", importData: "Import Data (JSON)", importSuccess: "Data imported successfully! Reloading...",
                themeLabel: "App Theme", streak: "Day Streak", manageTrackers: "Visible Trackers",
                checkIn: "Check In Location", checkedIn: "Checked In!", locationLog: "Location Log", city: "City",
                vibeLab: "Vibe Lab AI", vibeLabDesc: "Analyze hidden patterns", installApp: "Install App",
                wizardTitle: "Daily Check-in", wizardFinish: "Save Entry", next: "Next", back: "Back",
                features: [
                    { icon: "âš¡", title: "Daily Check-in Wizard", desc: "6-step flow: mood, emotions, anxiety, weather, health, and notes with auto-advance" },
                    { icon: "ðŸŽ™ï¸", title: "Voice Dictation", desc: "Speak your journal entries hands-free with continuous voice input" },
                    { icon: "ðŸ’šâ¤ï¸", title: "Sentiment Highlighting", desc: "Positive words turn green, negative words turn red as you type" },
                    { icon: "ðŸ’­", title: "Writing Prompts", desc: "20 daily prompts that change each day to inspire journaling" },
                    { icon: "ðŸŽ¨", title: "Custom Themes", desc: "8 preset themes, 10 photo backgrounds, or upload your own wallpaper" },
                    { icon: "ðŸ”’", title: "Privacy Lock", desc: "Set a 4-digit PIN to keep siblings out of your diary" },
                    { icon: "ðŸ“¸", title: "Snapshot Export", desc: "Download beautiful PNG images of your trackers for social sharing" },
                    { icon: "âœ¨", title: "Year in Review", desc: "Gorgeous annual summary with stats, moods, movies, songs, and cities" },
                    { icon: "ðŸŽ¯", title: "Drag-to-Paint", desc: "Click and drag across days to fill your mood grid faster" },
                    { icon: "ðŸ§ ", title: "Vibe Lab AI", desc: "AI-powered insights and correlations from your year's data" },
                    { icon: "ðŸŒ¤ï¸", title: "10-Day Weather", desc: "Extended forecast with auto-fill and beautiful icons" },
                    { icon: "ðŸ†", title: "Streak Tracking", desc: "Track your daily check-in streak and build consistency" }
                ],
                trackers: {
                    rateMyDay: { title: "Rate My Day", desc: "Track your daily overall vibe." },
                    emotions: { title: "Emotion Tracker", desc: "Log your dominant emotion." },
                    anxiety: { title: "Anxiety Tracker", desc: "Monitor your anxiety levels." },
                    weather: { title: "Weather Tracker", desc: "Track the daily weather." },
                    health: { title: "Health Tracker", desc: "Log physical health & symptoms." },
                    movies: { title: "Movie of the Month", desc: "Which movies defined this month?" },
                    songs: { title: "Song of the Month", desc: "Your monthly anthems." },
                    weekly_moments: { title: "Weekly Best Moments", desc: "Highlight of your week." },
                    travel: { title: "My Travel Track", desc: "Log visited cities & view map." },
                    locations: { title: "Location Tracker", desc: "Daily location check-in." }
                },
                levels: {
                    rateMyDay: {1: "Terrible", 2: "Bad", 3: "Okay", 4: "Good", 5: "Amazing"},
                    emotions: {happy: "Happy", sad: "Sad", excited: "Excited", in_love: "In Love", energized: "Energized", scared: "Scared", bored: "Bored", anxious: "Anxious", angry: "Angry"},
                    anxiety: {none: "No Anxiety", low: "Low", medium: "Medium", high: "High", severe: "Severe"},
                    weather: {sunny: "Sunny", cloudy: "Cloudy", windy: "Windy", foggy: "Foggy", rainy: "Rainy", snow: "Snow", thunder: "Thunder"},
                    health: {healthy: "Healthy", cold: "Cold", flu: "Flu", headache: "Headache", body_pain: "Body Pain", sore_throat: "Sore Throat", stomach_ache: "Stomach Ache", fever: "Fever"}
                },
                // V4 New Features
                yearInReview: "âœ¨ My Year in Review",
                downloadSnapshot: "ðŸ“¸ Download Snapshot",
                exporting: "Exporting...",
                themeCustomization: "ðŸŽ¨ Customize Theme",
                presetThemes: "Preset Themes",
                photoBackgrounds: "Photo Backgrounds",
                customUrl: "Custom URL",
                applyTheme: "Apply Theme",
                enterImageUrl: "Enter image URL (e.g., from Imgur)",
                pinLock: "ðŸ”’ Privacy Lock PIN (Optional)",
                pinHelper: "ðŸ’¡ Set a 4-digit PIN to lock your diary. Leave empty to disable lock.",
                pinWarning: "âš ï¸ PIN must be exactly 4 digits",
                pinReady: "âœ… PIN ready! Your diary will be locked.",
                enterPin: "Enter your 4-digit PIN",
                incorrectPin: "âŒ Incorrect PIN. Try again!",
                todaysPrompt: "Today's Writing Prompt",
                promptHelp1: "No pressure - write as much or as little as you want",
                promptHelp2: "Use the prompt above for inspiration",
                promptHelp3: "Try voice dictate for easier journaling",
                promptHelp4: "Your thoughts are private and safe here",
                releaseNotes: "ðŸ“‹ Release Notes",
                releaseNotesDesc: "Discover all the amazing features we've built!",
                builtWith: "Built with ðŸ’œ by Jiya",
                versionHistory: "Version History",
                yearSnapshot: "Year Snapshot",
                myTrackingJourney: "ðŸ“Š My Tracking Journey",
                daysLogged: "Days Logged",
                topEmotion: "Top Emotion",
                avgAnxiety: "Avg Anxiety",
                sunnyDays: "Sunny Days",
                exerciseDays: "Exercise Days",
                longestNote: "Longest Note",
                moviesWatched: "Movies Watched",
                songsLoved: "Songs Loved",
                tripsTaken: "Trips Taken",
                placesVisited: "Places Visited",
                moodBreakdown: "Mood Breakdown",
                topMovies: "Top Movies",
                topSongs: "Top Songs",
                citiesVisited: "Cities Visited"
            },
            pl: {
                welcome: "Witaj!", setupTitle: "Profil i Ustawienia", nameLabel: "Jak masz na imiÄ™?", ageLabel: "Ile masz lat?", locationLabel: "Twoja Lokalizacja", languageLabel: "Preferowany JÄ™zyk",
                omdbLabel: "Klucz API OMDb (Filmy)", omdbHint: "DomyÅ›lny zapewniony. Lub uÅ¼yj wÅ‚asnego z omdbapi.com", detectLoc: "Wykryj", uploadPhoto: "PrzeÅ›lij ZdjÄ™cie",
                letsGo: "Zaczynamy! ðŸš€", save: "Zapisz Profil", resetApp: "Resetuj AplikacjÄ™", resetConfirm: "JesteÅ› pewien? To usunie WSZYSTKIE twoje dane.",
                hello: "CzeÅ›Ä‡", yearProgress: "PostÄ™p Roku", dailyStatus: "Codzienne Sprawdzenie", missing: "Nie Å›ledziÅ‚eÅ›:",
                allCaughtUp: "ðŸŽ‰ JesteÅ› na bieÅ¼Ä…co! Niesamowite!", resetPage: "Resetuj StronÄ™", resetPageConfirm: "WyczyÅ›ciÄ‡ dane na tej stronie?",
                legend: "Legenda", months: ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze', 'Lip', 'Sie', 'Wrz', 'PaÅº', 'Lis', 'Gru'],
                week: "TydzieÅ„", listening: "SÅ‚ucham...", clickDictate: "Kliknij, aby dyktowaÄ‡", clickMagic: "Szukaj i Dodaj",
                addEntry: "Dodaj wpis...", customizeTitle: "Dostosuj Etykiety", customizeDesc: "Dotknij, aby zmieniÄ‡ nazwÄ™ emocji lub oceny",
                trending: "Popularne w Twojej okolicy", addToMonth: "Dodaj do bieÅ¼Ä…cego miesiÄ…ca", help: "Przewodnik", helpTitle: "âœ¨ Przewodnik po funkcjach âœ¨",
                forecast: "Prognoza 10-dniowa", autoFill: "AutouzupeÅ‚nianie Historii", autoFillConfirm: "Pobierze to dane pogodowe dla twojej lokalizacji i uzupeÅ‚ni puste dni. KontynuowaÄ‡?",
                dataMgmt: "ZarzÄ…dzanie Danymi", exportData: "Eksportuj Dane (JSON)", importData: "Importuj Dane (JSON)", importSuccess: "Dane zaimportowane pomyÅ›lnie! PrzeÅ‚adowywanie...",
                themeLabel: "Motyw Aplikacji", streak: "Dni z rzÄ™du", manageTrackers: "Widoczne Trackery",
                checkIn: "Zamelduj siÄ™", checkedIn: "Zameldowano!", locationLog: "Dziennik Lokalizacji", city: "Miasto",
                vibeLab: "Laboratorium Vibe AI", vibeLabDesc: "Analizuj ukryte wzorce", installApp: "Zainstaluj AplikacjÄ™",
                wizardTitle: "Codzienne zameldowanie", wizardFinish: "Zapisz wpis", next: "Dalej", back: "Wstecz",
                features: [
                    { icon: "âš¡", title: "Kreator Codzienny", desc: "6-krokowy przepÅ‚yw: nastrÃ³j, emocje, lÄ™k, pogoda, zdrowie i notatki z automatycznym przejÅ›ciem" },
                    { icon: "ðŸŽ™ï¸", title: "Dyktowanie GÅ‚osowe", desc: "MÃ³w swoje wpisy bez uÅ¼ycia rÄ…k dziÄ™ki ciÄ…gÅ‚emu wprowadzaniu gÅ‚osowemu" },
                    { icon: "ðŸ’šâ¤ï¸", title: "PodÅ›wietlanie Sentymentu", desc: "Pozytywne sÅ‚owa zamieniajÄ… siÄ™ w zielone, negatywne w czerwone podczas pisania" },
                    { icon: "ðŸ’­", title: "Podpowiedzi do Pisania", desc: "20 codziennych podpowiedzi, ktÃ³re zmieniajÄ… siÄ™ kaÅ¼dego dnia" },
                    { icon: "ðŸŽ¨", title: "WÅ‚asne Motywy", desc: "8 gotowych motywÃ³w, 10 tÅ‚a zdjÄ™Ä‡ lub przeÅ›lij wÅ‚asnÄ… tapetÄ™" },
                    { icon: "ðŸ”’", title: "Blokada PrywatnoÅ›ci", desc: "Ustaw 4-cyfrowy PIN, aby chroniÄ‡ pamiÄ™tnik przed rodzeÅ„stwem" },
                    { icon: "ðŸ“¸", title: "Eksport Migawek", desc: "Pobieraj piÄ™kne obrazy PNG swoich trackerÃ³w" },
                    { icon: "âœ¨", title: "Podsumowanie Roku", desc: "WspaniaÅ‚e roczne podsumowanie ze statystykami, nastrojami, filmami i piosenkami" },
                    { icon: "ðŸŽ¯", title: "PrzeciÄ…gnij i Maluj", desc: "Kliknij i przeciÄ…gnij przez dni, aby szybciej wypeÅ‚niÄ‡ siatkÄ™ nastroju" },
                    { icon: "ðŸ§ ", title: "Laboratorium Vibe AI", desc: "SpostrzeÅ¼enia AI i korelacje z danych z caÅ‚ego roku" },
                    { icon: "ðŸŒ¤ï¸", title: "10-Dniowa Pogoda", desc: "Rozszerzona prognoza z automatycznym wypeÅ‚nianiem" },
                    { icon: "ðŸ†", title: "Åšledzenie Serii", desc: "ÅšledÅº swojÄ… codziennÄ… seriÄ™ zameldowaÅ„" }
                ],
                trackers: {
                    rateMyDay: { title: "OceÅ„ MÃ³j DzieÅ„", desc: "ÅšledÅº swÃ³j ogÃ³lny nastrÃ³j." },
                    emotions: { title: "Emocje", desc: "Loguj dominujÄ…cÄ… emocjÄ™." },
                    anxiety: { title: "Poziom LÄ™ku", desc: "Monitoruj poziom niepokoju." },
                    weather: { title: "Pogoda", desc: "ÅšledÅº codziennÄ… pogodÄ™." },
                    health: { title: "Zdrowie", desc: "Loguj zdrowie fizyczne." },
                    movies: { title: "Film MiesiÄ…ca", desc: "Jakie filmy zdefiniowaÅ‚y ten miesiÄ…c?" },
                    songs: { title: "Piosenka MiesiÄ…ca", desc: "Twoje hymny miesiÄ…ca." },
                    weekly_moments: { title: "Momenty Tygodnia", desc: "Najlepsze chwile tygodnia." },
                    travel: { title: "Moje PodrÃ³Å¼e", desc: "Loguj miasta i mapÄ™." },
                    locations: { title: "Lokalizacja", desc: "Codzienne zameldowanie." }
                },
                levels: {
                    rateMyDay: {1: "Okropnie", 2: "Å¹le", 3: "Okej", 4: "Dobrze", 5: "Niesamowicie"},
                    emotions: {happy: "SzczÄ™Å›liwy", sad: "Smutny", excited: "Podekscytowany", in_love: "Zakochany", energized: "PeÅ‚en energii", scared: "Przestraszony", bored: "Znudzony", anxious: "Zaniepokojony", angry: "ZÅ‚y"},
                    anxiety: {none: "Brak", low: "Niski", medium: "Åšredni", high: "Wysoki", severe: "PowaÅ¼ny"},
                    weather: {sunny: "SÅ‚onecznie", cloudy: "Pochmurno", windy: "Wietrznie", foggy: "MgliÅ›cie", rainy: "Deszczowo", snow: "Åšnieg", thunder: "Burza"},
                    health: {healthy: "Zdrowy", cold: "PrzeziÄ™bienie", flu: "Grypa", headache: "BÃ³l gÅ‚owy", body_pain: "BÃ³l ciaÅ‚a", sore_throat: "BÃ³l gardÅ‚a", stomach_ache: "BÃ³l brzucha", fever: "GorÄ…czka"}
                },
                // V4 Nowe Funkcje
                yearInReview: "âœ¨ Podsumowanie Roku",
                downloadSnapshot: "ðŸ“¸ Pobierz MigawkÄ™",
                exporting: "Eksportowanie...",
                themeCustomization: "ðŸŽ¨ Dostosuj Motyw",
                presetThemes: "Gotowe Motywy",
                photoBackgrounds: "TÅ‚a ze ZdjÄ™Ä‡",
                customUrl: "WÅ‚asny URL",
                applyTheme: "Zastosuj Motyw",
                enterImageUrl: "WprowadÅº URL obrazu (np. z Imgur)",
                pinLock: "ðŸ”’ PIN Blokady PrywatnoÅ›ci (Opcjonalny)",
                pinHelper: "ðŸ’¡ Ustaw 4-cyfrowy PIN, aby zablokowaÄ‡ pamiÄ™tnik. Zostaw puste, aby wyÅ‚Ä…czyÄ‡ blokadÄ™.",
                pinWarning: "âš ï¸ PIN musi mieÄ‡ dokÅ‚adnie 4 cyfry",
                pinReady: "âœ… PIN gotowy! TwÃ³j pamiÄ™tnik bÄ™dzie zablokowany.",
                enterPin: "WprowadÅº swÃ³j 4-cyfrowy PIN",
                incorrectPin: "âŒ NieprawidÅ‚owy PIN. SprÃ³buj ponownie!",
                todaysPrompt: "Dzisiejsza PodpowiedÅº do Pisania",
                promptHelp1: "Bez presji - pisz tyle, ile chcesz",
                promptHelp2: "UÅ¼yj powyÅ¼szej podpowiedzi jako inspiracji",
                promptHelp3: "SprÃ³buj dyktowania gÅ‚osowego dla Å‚atwiejszego pisania",
                promptHelp4: "Twoje myÅ›li sÄ… prywatne i bezpieczne",
                releaseNotes: "ðŸ“‹ Informacje o Wydaniu",
                releaseNotesDesc: "Odkryj wszystkie niesamowite funkcje, ktÃ³re zbudowaliÅ›my!",
                builtWith: "Stworzone z ðŸ’œ przez Jiya",
                versionHistory: "Historia Wersji",
                yearSnapshot: "Migawka Roku",
                myTrackingJourney: "ðŸ“Š Moja PodrÃ³Å¼ ze Åšledzeniem",
                daysLogged: "Dni Zarejestrowane",
                topEmotion: "NajczÄ™stsza Emocja",
                avgAnxiety: "Åšr. LÄ™k",
                sunnyDays: "SÅ‚oneczne Dni",
                exerciseDays: "Dni Ä†wiczeÅ„",
                longestNote: "NajdÅ‚uÅ¼sza Notatka",
                moviesWatched: "Obejrzane Filmy",
                songsLoved: "Ulubione Piosenki",
                tripsTaken: "PodrÃ³Å¼e",
                placesVisited: "Odwiedzone Miejsca",
                moodBreakdown: "PodziaÅ‚ NastrojÃ³w",
                topMovies: "Najlepsze Filmy",
                topSongs: "Najlepsze Piosenki",
                citiesVisited: "Odwiedzone Miasta"
            },
            fr: {
                welcome: "Bienvenue!", setupTitle: "Profil et ParamÃ¨tres", nameLabel: "Comment vous appelez-vous?", ageLabel: "Quel Ã¢ge avez-vous?", locationLabel: "Votre Localisation", languageLabel: "Langue PrÃ©fÃ©rÃ©e",
                omdbLabel: "ClÃ© API OMDb (Films)", omdbHint: "Par dÃ©faut fourni. Ou utilisez le vÃ´tre depuis omdbapi.com", detectLoc: "DÃ©tecter", uploadPhoto: "TÃ©lÃ©charger Photo",
                letsGo: "C'est parti! ðŸš€", save: "Enregistrer Profil", resetApp: "RÃ©initialiser App", resetConfirm: "ÃŠtes-vous sÃ»r? Cela supprimera TOUTES vos donnÃ©es.",
                hello: "Bonjour", yearProgress: "Progression AnnÃ©e", dailyStatus: "VÃ©rification Quotidienne", missing: "Vous n'avez pas suivi:",
                allCaughtUp: "ðŸŽ‰ Vous Ãªtes Ã  jour pour aujourd'hui! Incroyable!", resetPage: "RÃ©initialiser Page", resetPageConfirm: "Effacer les donnÃ©es sur cette page?",
                legend: "LÃ©gende", months: ['Jan', 'FÃ©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'AoÃ»t', 'Sep', 'Oct', 'Nov', 'DÃ©c'],
                week: "Semaine", listening: "Ã‰coute...", clickDictate: "Cliquez pour dicter", clickMagic: "Chercher et Ajouter",
                addEntry: "Ajouter une entrÃ©e...", customizeTitle: "Personnaliser Ã‰tiquettes", customizeDesc: "Tapez pour renommer une Ã©motion ou une note",
                trending: "Tendances prÃ¨s de chez vous", addToMonth: "Ajouter au mois en cours", help: "Guide", helpTitle: "âœ¨ Guide des FonctionnalitÃ©s âœ¨",
                forecast: "PrÃ©visions 10 Jours", autoFill: "Remplissage Auto Historique", autoFillConfirm: "Cela rÃ©cupÃ©rera les donnÃ©es mÃ©tÃ©o passÃ©es pour votre localisation et remplira les jours vides. Continuer?",
                dataMgmt: "Gestion des DonnÃ©es", exportData: "Exporter DonnÃ©es (JSON)", importData: "Importer DonnÃ©es (JSON)", importSuccess: "DonnÃ©es importÃ©es avec succÃ¨s! Rechargement...",
                themeLabel: "ThÃ¨me App", streak: "Jours consÃ©cutifs", manageTrackers: "Trackers Visibles",
                checkIn: "S'enregistrer", checkedIn: "EnregistrÃ©!", locationLog: "Journal de Localisation", city: "Ville",
                vibeLab: "Laboratoire Vibe AI", vibeLabDesc: "Analyser les modÃ¨les cachÃ©s", installApp: "Installer l'App",
                wizardTitle: "Enregistrement Quotidien", wizardFinish: "Enregistrer", next: "Suivant", back: "Retour",
                features: [
                    { icon: "âš¡", title: "Assistant Quotidien", desc: "Flux en 6 Ã©tapes : humeur, Ã©motions, anxiÃ©tÃ©, mÃ©tÃ©o, santÃ© et notes avec avancement automatique" },
                    { icon: "ðŸŽ™ï¸", title: "DictÃ©e Vocale", desc: "Parlez vos entrÃ©es de journal sans les mains avec saisie vocale continue" },
                    { icon: "ðŸ’šâ¤ï¸", title: "Surlignage Sentiments", desc: "Les mots positifs deviennent verts, les nÃ©gatifs rouges en tapant" },
                    { icon: "ðŸ’­", title: "Invites d'Ã‰criture", desc: "20 invites quotidiennes qui changent chaque jour pour inspirer l'Ã©criture" },
                    { icon: "ðŸŽ¨", title: "ThÃ¨mes PersonnalisÃ©s", desc: "8 thÃ¨mes prÃ©dÃ©finis, 10 arriÃ¨re-plans photo ou tÃ©lÃ©chargez votre fond d'Ã©cran" },
                    { icon: "ðŸ”’", title: "Verrou de ConfidentialitÃ©", desc: "DÃ©finissez un code PIN Ã  4 chiffres pour protÃ©ger votre journal de vos frÃ¨res et sÅ“urs" },
                    { icon: "ðŸ“¸", title: "Export d'InstantanÃ©", desc: "TÃ©lÃ©chargez de belles images PNG de vos trackers" },
                    { icon: "âœ¨", title: "Bilan de l'AnnÃ©e", desc: "Magnifique rÃ©sumÃ© annuel avec statistiques, humeurs, films et chansons" },
                    { icon: "ðŸŽ¯", title: "Glisser pour Peindre", desc: "Cliquez et faites glisser sur les jours pour remplir plus rapidement votre grille d'humeur" },
                    { icon: "ðŸ§ ", title: "Laboratoire Vibe AI", desc: "Informations alimentÃ©es par l'IA et corrÃ©lations de vos donnÃ©es annuelles" },
                    { icon: "ðŸŒ¤ï¸", title: "MÃ©tÃ©o 10 Jours", desc: "PrÃ©visions Ã©tendues avec remplissage automatique" },
                    { icon: "ðŸ†", title: "Suivi de SÃ©rie", desc: "Suivez votre sÃ©rie d'enregistrement quotidien" }
                ],
                trackers: {
                    rateMyDay: { title: "Notez Ma JournÃ©e", desc: "Suivez votre humeur gÃ©nÃ©rale." },
                    emotions: { title: "Ã‰motions", desc: "Enregistrez votre Ã©motion dominante." },
                    anxiety: { title: "Niveau d'AnxiÃ©tÃ©", desc: "Surveillez votre niveau d'anxiÃ©tÃ©." },
                    weather: { title: "MÃ©tÃ©o", desc: "Suivez la mÃ©tÃ©o quotidienne." },
                    health: { title: "SantÃ©", desc: "Enregistrez la santÃ© physique." },
                    movies: { title: "Film du Mois", desc: "Quels films ont marquÃ© ce mois?" },
                    songs: { title: "Chanson du Mois", desc: "Vos hymnes du mois." },
                    weekly_moments: { title: "Moments de la Semaine", desc: "Le meilleur de votre semaine." },
                    travel: { title: "Mes Voyages", desc: "Enregistrez villes et carte." },
                    locations: { title: "Localisation", desc: "Enregistrement quotidien." }
                },
                levels: {
                    rateMyDay: {1: "Terrible", 2: "Mauvais", 3: "Moyen", 4: "Bon", 5: "Incroyable"},
                    emotions: {happy: "Heureux", sad: "Triste", excited: "ExcitÃ©", in_love: "Amoureux", energized: "Ã‰nergisÃ©", scared: "EffrayÃ©", bored: "EnnuyÃ©", anxious: "Anxieux", angry: "En colÃ¨re"},
                    anxiety: {none: "Aucune", low: "Faible", medium: "Moyenne", high: "Ã‰levÃ©e", severe: "SÃ©vÃ¨re"},
                    weather: {sunny: "EnsoleillÃ©", cloudy: "Nuageux", windy: "Venteux", foggy: "Brumeux", rainy: "Pluvieux", snow: "Neige", thunder: "Orage"},
                    health: {healthy: "En bonne santÃ©", cold: "Rhume", flu: "Grippe", headache: "Mal de tÃªte", body_pain: "Douleurs corporelles", sore_throat: "Mal de gorge", stomach_ache: "Maux d'estomac", fever: "FiÃ¨vre"}
                },
                // V4 Nouvelles FonctionnalitÃ©s
                yearInReview: "âœ¨ Mon Bilan de l'AnnÃ©e",
                downloadSnapshot: "ðŸ“¸ TÃ©lÃ©charger InstantanÃ©",
                exporting: "Exportation...",
                themeCustomization: "ðŸŽ¨ Personnaliser le ThÃ¨me",
                presetThemes: "ThÃ¨mes PrÃ©dÃ©finis",
                photoBackgrounds: "ArriÃ¨re-plans Photo",
                customUrl: "URL PersonnalisÃ©e",
                applyTheme: "Appliquer le ThÃ¨me",
                enterImageUrl: "Entrez l'URL de l'image (par ex., depuis Imgur)",
                pinLock: "ðŸ”’ Code PIN de ConfidentialitÃ© (Optionnel)",
                pinHelper: "ðŸ’¡ DÃ©finissez un code PIN Ã  4 chiffres pour verrouiller votre journal. Laissez vide pour dÃ©sactiver.",
                pinWarning: "âš ï¸ Le PIN doit comporter exactement 4 chiffres",
                pinReady: "âœ… PIN prÃªt ! Votre journal sera verrouillÃ©.",
                enterPin: "Entrez votre code PIN Ã  4 chiffres",
                incorrectPin: "âŒ Code PIN incorrect. RÃ©essayez !",
                todaysPrompt: "Invite d'Ã‰criture du Jour",
                promptHelp1: "Pas de pression - Ã©crivez autant ou aussi peu que vous voulez",
                promptHelp2: "Utilisez l'invite ci-dessus pour inspiration",
                promptHelp3: "Essayez la dictÃ©e vocale pour faciliter l'Ã©criture",
                promptHelp4: "Vos pensÃ©es sont privÃ©es et sÃ©curisÃ©es",
                releaseNotes: "ðŸ“‹ Notes de Version",
                releaseNotesDesc: "DÃ©couvrez toutes les fonctionnalitÃ©s incroyables que nous avons crÃ©Ã©es !",
                builtWith: "ConÃ§u avec ðŸ’œ par Jiya",
                versionHistory: "Historique des Versions",
                yearSnapshot: "InstantanÃ© de l'AnnÃ©e",
                myTrackingJourney: "ðŸ“Š Mon Parcours de Suivi",
                daysLogged: "Jours EnregistrÃ©s",
                topEmotion: "Ã‰motion Principale",
                avgAnxiety: "AnxiÃ©tÃ© Moy.",
                sunnyDays: "Jours EnsoleillÃ©s",
                exerciseDays: "Jours d'Exercice",
                longestNote: "Note la Plus Longue",
                moviesWatched: "Films RegardÃ©s",
                songsLoved: "Chansons AimÃ©es",
                tripsTaken: "Voyages EffectuÃ©s",
                placesVisited: "Lieux VisitÃ©s",
                moodBreakdown: "RÃ©partition des Humeurs",
                topMovies: "Meilleurs Films",
                topSongs: "Meilleures Chansons",
                citiesVisited: "Villes VisitÃ©es"
            },
            es: {
                welcome: "Â¡Bienvenido!", setupTitle: "Perfil y ConfiguraciÃ³n", nameLabel: "Â¿CÃ³mo te llamas?", ageLabel: "Â¿CuÃ¡ntos aÃ±os tienes?", locationLabel: "Tu UbicaciÃ³n", languageLabel: "Idioma Preferido",
                omdbLabel: "Clave API OMDb (PelÃ­culas)", omdbHint: "Predeterminado proporcionado. O usa el tuyo de omdbapi.com", detectLoc: "Detectar", uploadPhoto: "Subir Foto",
                letsGo: "Â¡Vamos! ðŸš€", save: "Guardar Perfil", resetApp: "Reiniciar App", resetConfirm: "Â¿EstÃ¡s seguro? Esto borrarÃ¡ TODOS tus datos.",
                hello: "Hola", yearProgress: "Progreso del AÃ±o", dailyStatus: "Estado Diario", missing: "No has registrado:",
                allCaughtUp: "ðŸŽ‰ Â¡EstÃ¡s al dÃ­a por hoy! Â¡IncreÃ­ble!", resetPage: "Reiniciar PÃ¡gina", resetPageConfirm: "Â¿Borrar datos en esta pÃ¡gina?",
                legend: "Leyenda", months: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                week: "Semana", listening: "Escuchando...", clickDictate: "Clic para dictar", clickMagic: "Buscar y AÃ±adir",
                addEntry: "AÃ±adir una entrada...", customizeTitle: "Personalizar Etiquetas", customizeDesc: "Toca para renombrar emociÃ³n o calificaciÃ³n",
                trending: "Tendencias cerca de ti", addToMonth: "AÃ±adir al mes actual", help: "GuÃ­a", helpTitle: "âœ¨ GuÃ­a de Funciones âœ¨",
                forecast: "PronÃ³stico 10 DÃ­as", autoFill: "Autocompletar Historial", autoFillConfirm: "Esto obtendrÃ¡ datos meteorolÃ³gicos pasados para tu ubicaciÃ³n y llenarÃ¡ los dÃ­as vacÃ­os. Â¿Continuar?",
                dataMgmt: "GestiÃ³n de Datos", exportData: "Exportar Datos (JSON)", importData: "Importar Datos (JSON)", importSuccess: "Â¡Datos importados con Ã©xito! Recargando...",
                themeLabel: "Tema de App", streak: "Racha de DÃ­as", manageTrackers: "Rastreadores Visibles",
                checkIn: "Registrarse", checkedIn: "Â¡Registrado!", locationLog: "Registro de UbicaciÃ³n", city: "Ciudad",
                vibeLab: "Laboratorio Vibe AI", vibeLabDesc: "Analizar patrones ocultos", installApp: "Instalar App",
                wizardTitle: "Registro Diario", wizardFinish: "Guardar Entrada", next: "Siguiente", back: "AtrÃ¡s",
                features: [
                    { icon: "âš¡", title: "Asistente Diario", desc: "Flujo de 6 pasos: Ã¡nimo, emociones, ansiedad, clima, salud y notas con avance automÃ¡tico" },
                    { icon: "ðŸŽ™ï¸", title: "Dictado por Voz", desc: "Habla tus entradas de diario sin usar las manos con entrada de voz continua" },
                    { icon: "ðŸ’šâ¤ï¸", title: "Resaltado de Sentimientos", desc: "Las palabras positivas se vuelven verdes, las negativas rojas al escribir" },
                    { icon: "ðŸ’­", title: "Indicaciones de Escritura", desc: "20 indicaciones diarias que cambian cada dÃ­a para inspirar la escritura" },
                    { icon: "ðŸŽ¨", title: "Temas Personalizados", desc: "8 temas predefinidos, 10 fondos de foto o sube tu propio fondo de pantalla" },
                    { icon: "ðŸ”’", title: "Bloqueo de Privacidad", desc: "Establece un PIN de 4 dÃ­gitos para proteger tu diario de hermanos" },
                    { icon: "ðŸ“¸", title: "Exportar InstantÃ¡nea", desc: "Descarga hermosas imÃ¡genes PNG de tus rastreadores" },
                    { icon: "âœ¨", title: "Resumen del AÃ±o", desc: "Hermoso resumen anual con estadÃ­sticas, Ã¡nimos, pelÃ­culas y canciones" },
                    { icon: "ðŸŽ¯", title: "Arrastrar para Pintar", desc: "Haz clic y arrastra a travÃ©s de los dÃ­as para llenar tu cuadrÃ­cula de Ã¡nimo mÃ¡s rÃ¡pido" },
                    { icon: "ðŸ§ ", title: "Laboratorio Vibe AI", desc: "InformaciÃ³n impulsada por IA y correlaciones de tus datos anuales" },
                    { icon: "ðŸŒ¤ï¸", title: "Clima de 10 DÃ­as", desc: "PronÃ³stico extendido con autocompletado" },
                    { icon: "ðŸ†", title: "Rastreo de Racha", desc: "Rastrea tu racha de registro diario" }
                ],
                trackers: {
                    rateMyDay: { title: "Califica Mi DÃ­a", desc: "Rastrea tu vibra diaria general." },
                    emotions: { title: "Emociones", desc: "Registra tu emociÃ³n dominante." },
                    anxiety: { title: "Nivel de Ansiedad", desc: "Monitorea tus niveles de ansiedad." },
                    weather: { title: "Clima", desc: "Rastrea el clima diario." },
                    health: { title: "Salud", desc: "Registra salud fÃ­sica y sÃ­ntomas." },
                    movies: { title: "PelÃ­cula del Mes", desc: "Â¿QuÃ© pelÃ­culas definieron este mes?" },
                    songs: { title: "CanciÃ³n del Mes", desc: "Tus himnos mensuales." },
                    weekly_moments: { title: "Momentos de la Semana", desc: "Lo mejor de tu semana." },
                    travel: { title: "Mis Viajes", desc: "Registra ciudades y mapa." },
                    locations: { title: "UbicaciÃ³n", desc: "Registro diario." }
                },
                levels: {
                    rateMyDay: {1: "Terrible", 2: "Malo", 3: "Regular", 4: "Bueno", 5: "IncreÃ­ble"},
                    emotions: {happy: "Feliz", sad: "Triste", excited: "Emocionado", in_love: "Enamorado", energized: "Energizado", scared: "Asustado", bored: "Aburrido", anxious: "Ansioso", angry: "Enojado"},
                    anxiety: {none: "Ninguna", low: "Baja", medium: "Media", high: "Alta", severe: "Severa"},
                    weather: {sunny: "Soleado", cloudy: "Nublado", windy: "Ventoso", foggy: "Neblinoso", rainy: "Lluvioso", snow: "Nieve", thunder: "Tormenta"},
                    health: {healthy: "Saludable", cold: "Resfriado", flu: "Gripe", headache: "Dolor de cabeza", body_pain: "Dolor corporal", sore_throat: "Dolor de garganta", stomach_ache: "Dolor de estÃ³mago", fever: "Fiebre"}
                },
                // V4 Nuevas Funciones
                yearInReview: "âœ¨ Mi Resumen del AÃ±o",
                downloadSnapshot: "ðŸ“¸ Descargar InstantÃ¡nea",
                exporting: "Exportando...",
                themeCustomization: "ðŸŽ¨ Personalizar Tema",
                presetThemes: "Temas Predefinidos",
                photoBackgrounds: "Fondos de Foto",
                customUrl: "URL Personalizada",
                applyTheme: "Aplicar Tema",
                enterImageUrl: "Ingresa URL de imagen (ej., desde Imgur)",
                pinLock: "ðŸ”’ PIN de Privacidad (Opcional)",
                pinHelper: "ðŸ’¡ Establece un PIN de 4 dÃ­gitos para bloquear tu diario. DÃ©jalo vacÃ­o para desactivar.",
                pinWarning: "âš ï¸ El PIN debe tener exactamente 4 dÃ­gitos",
                pinReady: "âœ… Â¡PIN listo! Tu diario estarÃ¡ bloqueado.",
                enterPin: "Ingresa tu PIN de 4 dÃ­gitos",
                incorrectPin: "âŒ PIN incorrecto. Â¡IntÃ©ntalo de nuevo!",
                todaysPrompt: "IndicaciÃ³n de Escritura del DÃ­a",
                promptHelp1: "Sin presiÃ³n - escribe tanto o tan poco como quieras",
                promptHelp2: "Usa la indicaciÃ³n de arriba como inspiraciÃ³n",
                promptHelp3: "Prueba el dictado por voz para escribir mÃ¡s fÃ¡cilmente",
                promptHelp4: "Tus pensamientos son privados y seguros",
                releaseNotes: "ðŸ“‹ Notas de VersiÃ³n",
                releaseNotesDesc: "Â¡Descubre todas las increÃ­bles funciones que hemos construido!",
                builtWith: "Hecho con ðŸ’œ por Jiya",
                versionHistory: "Historial de Versiones",
                yearSnapshot: "InstantÃ¡nea del AÃ±o",
                myTrackingJourney: "ðŸ“Š Mi Viaje de Seguimiento",
                daysLogged: "DÃ­as Registrados",
                topEmotion: "EmociÃ³n Principal",
                avgAnxiety: "Ansiedad Prom.",
                sunnyDays: "DÃ­as Soleados",
                exerciseDays: "DÃ­as de Ejercicio",
                longestNote: "Nota MÃ¡s Larga",
                moviesWatched: "PelÃ­culas Vistas",
                songsLoved: "Canciones Amadas",
                tripsTaken: "Viajes Realizados",
                placesVisited: "Lugares Visitados",
                moodBreakdown: "Desglose de Ãnimos",
                topMovies: "Mejores PelÃ­culas",
                topSongs: "Mejores Canciones",
                citiesVisited: "Ciudades Visitadas"
            }
        };


        const THEMES = {
            playful: { id: 'playful', label: 'Playful', bg: 'bg-gradient-to-br from-pink-300 via-purple-300 to-indigo-400', text: 'text-slate-900', font: 'font-playful', card: 'bg-white/90 backdrop-blur-sm', accent: 'text-indigo-600' },
            professional: { id: 'professional', label: 'Focus', bg: 'bg-slate-100', text: 'text-slate-800', font: 'font-professional', card: 'bg-white shadow-sm border border-slate-200', accent: 'text-slate-900' },
            dark: { id: 'dark', label: 'Night', bg: 'bg-slate-900', text: 'text-slate-100', font: 'font-professional', card: 'bg-slate-800 border border-slate-700', accent: 'text-indigo-400' }
        };

        const SENTIMENT_KEYWORDS = {
            positive: ['happy', 'good', 'great', 'awesome', 'excited', 'love', 'fun', 'best', 'played', 'enjoyed', 'amazing', 'fantastic', 'calm', 'peaceful', 'productive', 'win', 'won', 'szczÄ™Å›liwy', 'dobrze', 'super', 'kocham'],
            negative: ['sad', 'bad', 'terrible', 'awful', 'angry', 'hate', 'hard', 'tired', 'bored', 'anxious', 'stress', 'stressed', 'fail', 'lost', 'sick', 'pain', 'lonely', 'smutny', 'Åºle', 'zmÄ™czony', 'nuda']
        };


        // ===== PERMISSION MANAGER FOR ANDROID =====
        const PermissionManager = {
            requestLocation: async () => {
                if (!navigator.geolocation) {
                    alert('Geolocation not supported');
                    return { granted: false };
                }
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });
                    return { granted: true, coords: position.coords };
                } catch (error) {
                    alert('Location permission denied. Enable in browser settings.');
                    return { granted: false, error };
                }
            },

            requestMicrophone: async () => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Microphone not supported');
                    return { granted: false };
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    return { granted: true };
                } catch (error) {
                    alert('Microphone permission denied. Enable in browser settings.');
                    return { granted: false, error };
                }
            },

            requestAll: async () => {
                const results = {};
                const locationResult = await PermissionManager.requestLocation();
                results.location = locationResult.granted;
                const micResult = await PermissionManager.requestMicrophone();
                results.microphone = micResult.granted;
                return results;
            }
        };

        // --- CORE FUNCTIONS (Firebase, Utils) ---
        const getFirebaseConfig = () => typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const firebaseConfig = getFirebaseConfig();
        const isLocal = !firebaseConfig; 
        if (!isLocal && !firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase init failed:", e); } }
        const auth = isLocal ? null : firebase.auth();
        const db = isLocal ? null : firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getCountryCode = (locationString) => {
            if (!locationString) return 'us';
            const lower = locationString.toLowerCase();
            if (lower.includes('uk') || lower.includes('london') || lower.includes('england')) return 'gb';
            return 'us';
        };

        const useDataPersistence = () => {
            const saveData = async (userId, collectionName, docId, data) => {
                if (isLocal) {
                    const key = `vibevault_${userId}_${collectionName}_${docId}`;
                    const existing = JSON.parse(localStorage.getItem(key) || '{}');
                    localStorage.setItem(key, JSON.stringify({ ...existing, ...data }));
                    return;
                }
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection(collectionName).doc(docId).set(data, { merge: true });
            };
            const subscribeToData = (userId, collectionName, docId, callback) => {
                if (isLocal) { const key = `vibevault_${userId}_${collectionName}_${docId}`; callback(JSON.parse(localStorage.getItem(key) || '{}')); return () => {}; }
                return db.collection('artifacts').doc(appId).collection('users').doc(userId).collection(collectionName).doc(docId).onSnapshot((docSnap) => callback(docSnap.exists ? docSnap.data() : {}), (err) => console.error("Sync error:", err));
            };
            const clearData = async (userId, collectionName, docId) => {
                if (isLocal) {
                    if (collectionName === 'all') Object.keys(localStorage).forEach(key => { if (key.startsWith('vibevault_')) localStorage.removeItem(key); });
                    else localStorage.removeItem(`vibevault_${userId}_${collectionName}_${docId}`);
                    return;
                }
                await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection(collectionName).doc(docId).delete();
            };
            const exportData = async (userId) => {
                 if (isLocal) { const data = {}; Object.keys(localStorage).forEach(key => { if (key.startsWith(`vibevault_${userId}`)) data[key] = JSON.parse(localStorage.getItem(key)); }); return data; }
                 alert("Cloud export currently supports Profile only."); return {};
            };
            const importData = async (userId, data) => {
                if (isLocal) { Object.entries(data).forEach(([key, val]) => { if(key.startsWith('vibevault_')) localStorage.setItem(key, JSON.stringify(val)); }); return true; }
                return false;
            };
            return { saveData, subscribeToData, clearData, exportData, importData };
        };

        const compressImage = (file, maxWidth = 300) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); let w = img.width, h = img.height;
                        if (w > h) { if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } } else { if (h > maxWidth) { w *= maxWidth / h; h = maxWidth; } }
                        canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        const searchMetadata = async (type, query, apiKey) => {
            if (!query) return [];
            try {
                if (type === 'movies') {
                    if (!apiKey) return [];
                    const res = await fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(query)}&apikey=${apiKey}`);
                    const data = await res.json();
                    if (data.Response === "True" && data.Search) return data.Search.slice(0, 5).map(m => ({ id: m.imdbID, title: m.Title, subtitle: m.Year, image: m.Poster !== "N/A" ? m.Poster : null, type: 'movie' }));
                } else if (type === 'songs') {
                    // Use iTunes API for song search
                    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=song&limit=10`);
                    const data = await res.json();
                    if (data.results && data.results.length > 0) {
                        return data.results.map(s => ({
                            id: s.trackId,
                            title: s.trackName,
                            subtitle: s.artistName,
                            image: s.artworkUrl100,
                            info: s.collectionName,
                            link: `https://www.youtube.com/results?search_query=${encodeURIComponent(s.trackName + ' ' + s.artistName)}`,
                            type: 'song'
                        }));
                    }
                }
            } catch (e) { console.error("Search error", e); }
            return [];
        };

        const fetchDetails = async (type, id, apiKey) => {
             try {
                if (type === 'movies') {
                    const res = await fetch(`https://www.omdbapi.com/?i=${id}&apikey=${apiKey}`);
                    const data = await res.json();
                    return { title: data.Title, subtitle: `${data.Year} â€¢ ${data.Rated}`, image: data.Poster !== "N/A" ? data.Poster : null, info: `â­ ${data.imdbRating} | ${data.Plot}`, link: `https://www.imdb.com/title/${data.imdbID}` };
                }
                return null; 
             } catch(e) { return null; }
        };
        
        const FALLBACK_TRENDING = {
            movies: [ { title: "Inception", subtitle: "Sci-Fi", image: "https://m.media-amazon.com/images/M/MV5BMjAxMzY3NjcxNF5BMl5BanBnXkFtZTcwNTI5OTM0Mw@@._V1_SX300.jpg", link: "https://www.imdb.com/title/tt1375666/" }, { title: "The Dark Knight", subtitle: "Action", image: "https://m.media-amazon.com/images/M/MV5BMTMxNTMwODM0NF5BMl5BanBnXkFtZTcwODAyMTk2Mw@@._V1_SX300.jpg", link: "https://www.imdb.com/title/tt0468569/" } ],
            songs: [ { title: "Blinding Lights", subtitle: "The Weeknd", image: "https://upload.wikimedia.org/wikipedia/en/e/e6/The_Weeknd_-_Blinding_Lights.png", link: "https://www.youtube.com/results?search_query=Blinding+Lights+The+Weeknd" }, { title: "Levitating", subtitle: "Dua Lipa", image: "https://upload.wikimedia.org/wikipedia/en/8/83/Dua_Lipa_-_Levitating.png", link: "https://www.youtube.com/results?search_query=Levitating+Dua+Lipa" } ]
        };

        const fetchTrending = async (type, countryCode) => {
            const limit = 5;
            const getUrl = (cc) => (type === 'movies' ? `https://rss.applemarketingtools.com/api/v2/${cc}/movies/top-movies/${limit}/movies.json` : `https://rss.applemarketingtools.com/api/v2/${cc}/music/most-played/${limit}/songs.json`);
            const fetchWithProxy = async (targetUrl) => {
                const proxies = [ u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`, u => `https://corsproxy.io/?${encodeURIComponent(u)}` ];
                for (const proxy of proxies) { try { const res = await fetch(proxy(targetUrl)); if (!res.ok) continue; const data = await res.json(); if (data.feed && data.feed.results) return data.feed.results; } catch (e) {} }
                throw new Error("Invalid structure");
            };
            try { try { const results = await fetchWithProxy(getUrl(countryCode)); return mapResults(results, type); } catch (e) { if (countryCode !== 'us') { const results = await fetchWithProxy(getUrl('us')); return mapResults(results, type); } throw e; } } catch (e) { console.warn("Trending fetch failed, using fallback."); return FALLBACK_TRENDING[type] ? FALLBACK_TRENDING[type].map(i => ({...i, meta: i})) : []; }
        };

        const mapResults = (results, type) => {
             if (type === 'movies') return results.map(m => ({ title: m.name, subtitle: m.artistName, image: m.artworkUrl100, info: `ðŸ“… ${m.releaseDate}`, link: m.url, meta: { title: m.name, subtitle: m.artistName, image: m.artworkUrl100, info: `ðŸ“… ${m.releaseDate}`, link: m.url } }));
             return results.map(s => { const youtubeLink = `https://www.youtube.com/results?search_query=${encodeURIComponent(s.name + ' ' + s.artistName)}`; return { title: s.name, subtitle: s.artistName, image: s.artworkUrl100, info: s.genres?.[0]?.name, link: youtubeLink, meta: { title: s.name, subtitle: s.artistName, image: s.artworkUrl100, info: s.genres?.[0]?.name, link: youtubeLink } }; });
        };

        const fetchWeatherHistory = async (lat, lon, year) => { 
            const today = new Date(); let endDateStr = `${year}-12-31`; if (year === today.getFullYear()) endDateStr = today.toISOString().split('T')[0];
            try { const res = await fetch(`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${year}-01-01&end_date=${endDateStr}&daily=weather_code&timezone=auto`); const data = await res.json(); if (!data.daily || !data.daily.weather_code) return null; const history = {}; const WMO_TO_APP_MAP = { 0: 'sunny', 1: 'sunny', 2: 'cloudy', 3: 'cloudy', 45: 'foggy', 51: 'rainy', 61: 'rainy', 71: 'snow', 95: 'thunder' }; data.daily.time.forEach((t, idx) => { const dateParts = t.split('-'); const appValue = WMO_TO_APP_MAP[data.daily.weather_code[idx]]; if (appValue) history[`${parseInt(dateParts[1]) - 1}-${parseInt(dateParts[2])}`] = appValue; }); return history; } catch (e) { return null; }
        };

        const fetchWeatherForecast = async (lat, lon) => { 
            if (!lat || !lon) return [];
            try { 
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&forecast_days=10&timezone=auto`); 
                const data = await res.json(); 
                if (!data.daily) return []; 
                // Expanded weather code to icon mapping to fix question marks
                const icons = { 
                    0: "â˜€ï¸",    // Clear sky
                    1: "ðŸŒ¤ï¸",   // Mainly clear
                    2: "â›…",    // Partly cloudy
                    3: "â˜ï¸",    // Overcast
                    45: "ðŸŒ«ï¸",  // Fog
                    48: "ðŸŒ«ï¸",  // Depositing rime fog
                    51: "ðŸŒ¦ï¸",  // Light drizzle
                    53: "ðŸŒ¦ï¸",  // Moderate drizzle
                    55: "ðŸŒ¦ï¸",  // Dense drizzle
                    56: "ðŸŒ§ï¸",  // Light freezing drizzle
                    57: "ðŸŒ§ï¸",  // Dense freezing drizzle
                    61: "ðŸŒ§ï¸",  // Slight rain
                    63: "ðŸŒ§ï¸",  // Moderate rain
                    65: "ðŸŒ§ï¸",  // Heavy rain
                    66: "ðŸŒ§ï¸",  // Light freezing rain
                    67: "ðŸŒ§ï¸",  // Heavy freezing rain
                    71: "â„ï¸",   // Slight snow
                    73: "â„ï¸",   // Moderate snow
                    75: "â„ï¸",   // Heavy snow
                    77: "â„ï¸",   // Snow grains
                    80: "ðŸŒ¦ï¸",  // Slight rain showers
                    81: "ðŸŒ§ï¸",  // Moderate rain showers
                    82: "ðŸŒ§ï¸",  // Violent rain showers
                    85: "â„ï¸",   // Slight snow showers
                    86: "â„ï¸",   // Heavy snow showers
                    95: "â›ˆï¸",   // Thunderstorm
                    96: "â›ˆï¸",   // Thunderstorm with slight hail
                    99: "â›ˆï¸"    // Thunderstorm with heavy hail
                }; 
                return data.daily.time.slice(0, 10).map((time, index) => ({ 
                    day: new Date(time).toLocaleDateString('en-US', { weekday: 'short' }), 
                    date: new Date(time).getDate(), 
                    icon: icons[data.daily.weather_code[index]] || "ðŸŒ¤ï¸", // Default to partly cloudy instead of question mark
                    max: Math.round(data.daily.temperature_2m_max[index]), 
                    min: Math.round(data.daily.temperature_2m_min[index]) 
                })); 
            } catch (e) { return []; }
        };

        const getTrackerConfigs = (lang = 'en') => {
            const t = TRANSLATIONS[lang] || TRANSLATIONS['en'];
            const levels = t.levels || TRANSLATIONS['en'].levels;
            return {
                rateMyDay: { id: 'rateMyDay', type: 'pixel', levels: [ { value: 1, label: levels.rateMyDay[1], defaultColor: '#ef4444' }, { value: 2, label: levels.rateMyDay[2], defaultColor: '#f97316' }, { value: 3, label: levels.rateMyDay[3], defaultColor: '#eab308' }, { value: 4, label: levels.rateMyDay[4], defaultColor: '#84cc16' }, { value: 5, label: levels.rateMyDay[5], defaultColor: '#22c55e' } ] },
                emotions: { id: 'emotions', type: 'pixel', levels: [ { value: 'happy', label: levels.emotions.happy, defaultColor: '#fbbf24' }, { value: 'sad', label: levels.emotions.sad, defaultColor: '#60a5fa' }, { value: 'excited', label: levels.emotions.excited, defaultColor: '#fb923c' }, { value: 'in_love', label: levels.emotions.in_love, defaultColor: '#ec4899' }, { value: 'energized', label: levels.emotions.energized, defaultColor: '#a3e635' }, { value: 'scared', label: levels.emotions.scared, defaultColor: '#a78bfa' }, { value: 'bored', label: levels.emotions.bored, defaultColor: '#94a3b8' }, { value: 'anxious', label: levels.emotions.anxious, defaultColor: '#2dd4bf' }, { value: 'angry', label: levels.emotions.angry, defaultColor: '#ef4444' } ] },
                anxiety: { id: 'anxiety', type: 'pixel', levels: [ { value: 'none', label: levels.anxiety.none, defaultColor: '#4ade80' }, { value: 'low', label: levels.anxiety.low, defaultColor: '#facc15' }, { value: 'medium', label: levels.anxiety.medium, defaultColor: '#fb923c' }, { value: 'high', label: levels.anxiety.high, defaultColor: '#f87171' }, { value: 'severe', label: levels.anxiety.severe, defaultColor: '#b91c1c' } ] },
                weather: { id: 'weather', type: 'pixel', levels: [ { value: 'sunny', label: levels.weather.sunny, defaultColor: '#fde047' }, { value: 'cloudy', label: levels.weather.cloudy, defaultColor: '#94a3b8' }, { value: 'windy', label: levels.weather.windy, defaultColor: '#bae6fd' }, { value: 'foggy', label: levels.weather.foggy, defaultColor: '#cbd5e1' }, { value: 'rainy', label: levels.weather.rainy, defaultColor: '#3b82f6' }, { value: 'snow', label: levels.weather.snow, defaultColor: '#e0f2fe' }, { value: 'thunder', label: levels.weather.thunder, defaultColor: '#6366f1' } ] },
                health: { id: 'health', type: 'pixel', levels: [ { value: 'healthy', label: levels.health.healthy, defaultColor: '#22c55e' }, { value: 'cold', label: levels.health.cold, defaultColor: '#60a5fa' }, { value: 'flu', label: levels.health.flu, defaultColor: '#818cf8' }, { value: 'headache', label: levels.health.headache, defaultColor: '#f87171' }, { value: 'body_pain', label: levels.health.body_pain, defaultColor: '#fb923c' }, { value: 'sore_throat', label: levels.health.sore_throat, defaultColor: '#f472b6' }, { value: 'stomach_ache', label: levels.health.stomach_ache, defaultColor: '#a8a29e' }, { value: 'fever', label: levels.health.fever, defaultColor: '#ef4444' } ] },
                movies: { id: 'movies', type: 'monthly_notes' },
                songs: { id: 'songs', type: 'monthly_notes' },
                weekly_moments: { id: 'weekly_moments', type: 'weekly_notes' },
                travel: { id: 'travel', type: 'travel_map' },
                locations: { id: 'locations', type: 'daily_log' }
            };
        };
        
        // Custom week calculation: Week 1 = Jan 1 to first Sat, Week 2+ = Mon-Sun
        const getWeekNumber = (date) => {
            const year = date.getFullYear();
            const jan1 = new Date(year, 0, 1);
            const jan1Day = jan1.getDay(); // 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat
            
            // Find first Saturday
            let daysToFirstSat;
            if (jan1Day === 0) { // If Jan 1 is Sunday
                daysToFirstSat = 6;
            } else if (jan1Day === 6) { // If Jan 1 is Saturday
                daysToFirstSat = 0;
            } else { // Jan 1 is Mon-Fri
                daysToFirstSat = 6 - jan1Day;
            }
            
            const firstSatDayNum = 1 + daysToFirstSat;
            
            // Calculate day of year for input date
            const dayOfYear = Math.floor((date - jan1) / (1000 * 60 * 60 * 24)) + 1;
            
            // If date is in Week 1 (Jan 1 to first Saturday)
            if (dayOfYear <= firstSatDayNum) {
                return 1;
            }
            
            // First Monday is 2 days after first Saturday (Sat -> Sun -> Mon)
            const firstMondayDayNum = firstSatDayNum + 2;
            
            // Otherwise, calculate which Mon-Sun week it falls in
            const daysFromFirstMonday = dayOfYear - firstMondayDayNum;
            return Math.floor(daysFromFirstMonday / 7) + 2;
        };
        
        const getWeekRange = (weekNum, year) => {
            const jan1 = new Date(year, 0, 1);
            const jan1Day = jan1.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            
            // Find first Saturday
            let daysToFirstSat;
            if (jan1Day === 0) { // If Jan 1 is Sunday
                daysToFirstSat = 6;
            } else if (jan1Day === 6) { // If Jan 1 is Saturday
                daysToFirstSat = 0;
            } else { // Jan 1 is Mon-Fri
                daysToFirstSat = 6 - jan1Day;
            }
            
            const firstSatDayNum = 1 + daysToFirstSat;
            
            // Week 1: Jan 1 to first Saturday
            if (weekNum === 1) {
                const weekStart = new Date(year, 0, 1);
                const weekEnd = new Date(year, 0, firstSatDayNum);
                return `${weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${weekEnd.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
            }
            
            // Week 2+: Monday to Sunday
            // First Monday is 2 days after first Saturday
            const firstMondayDayNum = firstSatDayNum + 2;
            
            // Calculate start and end for this week
            const weekStartDayNum = firstMondayDayNum + (weekNum - 2) * 7;
            const weekEndDayNum = weekStartDayNum + 6;
            
            const weekStart = new Date(year, 0, weekStartDayNum);
            const weekEnd = new Date(year, 0, weekEndDayNum);
            
            return `${weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${weekEnd.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
        };
        
        const DEFAULT_TRACKER_CONFIGS = getTrackerConfigs('en');
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const DAYS = Array.from({ length: 31 }, (_, i) => i + 1);
        const WEEKS = Array.from({ length: 52 }, (_, i) => i + 1);
        const TRACKER_ORDER = ['rateMyDay', 'emotions', 'anxiety', 'weather', 'health', 'movies', 'songs', 'weekly_moments', 'travel', 'locations'];

        // --- ICONS ---
        const IconArrowLeft = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const IconChevronLeft = ({ className, onClick }) => <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>;
        const IconChevronRight = ({ className, onClick }) => <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>;
        const IconCalendar = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const IconSmile = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>;
        const IconActivity = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const IconCloudRain = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>;
        const IconHeart = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
        const IconSettings = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconCamera = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
        const IconFilm = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>;
        const IconMusic = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>;
        const IconStar = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
        const IconMic = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/></svg>;
        const IconUser = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const IconTrash = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const IconMap = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>;
        const IconGlobe = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/></svg>;
        const IconEdit = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const IconChevronDown = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>;
        const IconHelp = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>;
        const IconWand = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>;
        const IconX = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const IconPlus = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const IconFire = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a1 1 0 0 1 .4.5c.34.69.58 1.44.5 2.3z"/></svg>;
        const IconBolt = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const IconDownload = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconUpload = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const IconFlask = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 2h4"/><path d="M6 14v6a3 3 0 0 0 3 3h6a3 3 0 0 0 3-3v-6"/><path d="M9 2v4l-5 8"/><path d="M15 2v4l5 8"/></svg>;

        // --- CUSTOM SVG LOGO ---
        // Moved to the top of component section to ensure scope availability
        const JiyaZeeLogo = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" className={className}>
                <defs>
                    <linearGradient id="brandGrad" x1="0" y1="0" x2="1" y2="1">
                        <stop offset="0%" stopColor="#818cf8"/>
                        <stop offset="100%" stopColor="#f472b6"/>
                    </linearGradient>
                    <filter id="shadow">
                        <feDropShadow dx="0" dy="2" stdDeviation="2" floodColor="#000" floodOpacity="0.2"/>
                    </filter>
                </defs>
                <circle cx="50" cy="50" r="48" fill="url(#brandGrad)" stroke="white" strokeWidth="3" />
                <path d="M80 25 L82 30 L87 32 L82 34 L80 39 L78 34 L73 32 L78 30 Z" fill="#fef08a" filter="url(#shadow)"/>
                <path d="M20 75 L22 80 L27 82 L22 84 L20 89 L18 84 L13 82 L18 80 Z" fill="#fef08a" opacity="0.6"/>
                <text x="50" y="65" fontSize="42" fontWeight="800" fill="white" textAnchor="middle" fontFamily="Fredoka, sans-serif" letterSpacing="1" filter="url(#shadow)">JZ</text>
                <path d="M35,72 Q50,82 65,72" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" opacity="0.8"/>
            </svg>
        );

        // --- COMPONENTS ---
        
        const SentimentInput = ({ value, onChange }) => {
            const containerRef = useRef(null);
            
            const renderHighlightedText = () => {
                if (!value) return null;
                const words = value.split(/(\s+)/);
                return words.map((word, i) => {
                    const cleanWord = word.toLowerCase().replace(/[^a-z]/g, '');
                    if (SENTIMENT_KEYWORDS.positive.includes(cleanWord)) return <span key={i} className="highlight-positive">{word}</span>;
                    if (SENTIMENT_KEYWORDS.negative.includes(cleanWord)) return <span key={i} className="highlight-negative">{word}</span>;
                    return word;
                });
            };

            return (
                <div className="relative w-full h-32 rounded-xl bg-slate-50 border border-slate-200 overflow-hidden focus-within:ring-2 focus-within:ring-indigo-300 transition-all">
                    <div className="absolute inset-0 p-3 whitespace-pre-wrap break-words pointer-events-none text-transparent z-0 font-sans text-sm" aria-hidden="true">
                        {value}
                    </div>
                    <div className="absolute inset-0 p-3 whitespace-pre-wrap break-words pointer-events-none text-slate-800 z-10 font-sans text-sm">
                        {renderHighlightedText()}
                    </div>
                    <textarea 
                        value={value} 
                        onChange={(e) => onChange(e.target.value)} 
                        className="absolute inset-0 w-full h-full p-3 bg-transparent text-transparent caret-indigo-600 focus:outline-none resize-none z-20 font-sans text-sm"
                        placeholder="How was your day? (Try words like 'fun' or 'tired')"
                    />
                </div>
            );
        };

        const WizardModal = ({ isOpen, onClose, t, activeConfig, onSave }) => {
            const [step, setStep] = useState(0);
            const [data, setData] = useState({ mood: null, emotion: null, anxiety: null, weatherFactors: [], healthFactors: [], note: '' });
            const [isRecording, setIsRecording] = useState(false);
            const [dailyPrompt, setDailyPrompt] = useState('');
            const recognitionRef = useRef(null);
            
            // 20 Surprise Prompts for daily inspiration
            const surprisePrompts = [
                "What made you laugh today? ðŸ˜„",
                "What was the hardest part of today? ðŸ’ª",
                "Who made you smile today? ðŸ˜Š",
                "What are you grateful for right now? ðŸ™",
                "What's something you learned today? ðŸ“š",
                "Describe today in 3 words âœ¨",
                "What was the best part of your day? â­",
                "What challenged you today? ðŸŽ¯",
                "Who did you help today? ðŸ¤",
                "What made you feel proud? ðŸ†",
                "What surprised you today? ðŸ˜®",
                "What are you looking forward to tomorrow? ðŸŒ…",
                "What made you feel loved today? ðŸ’•",
                "What's one thing you accomplished? âœ…",
                "What did you do for yourself today? ðŸŒ¸",
                "What's on your mind right now? ðŸ’­",
                "What made today special? âœ¨",
                "What would you tell your future self about today? ðŸ“",
                "What kindness did you witness or give? ðŸ’",
                "What's one thing you want to remember from today? ðŸŒŸ"
            ];
            
            // Get daily prompt (changes once per day)
            useEffect(() => {
                if (isOpen) {
                    const today = new Date().toDateString();
                    const savedPromptDate = localStorage.getItem('vibevault_prompt_date');
                    const savedPrompt = localStorage.getItem('vibevault_daily_prompt');
                    
                    if (savedPromptDate === today && savedPrompt) {
                        setDailyPrompt(savedPrompt);
                    } else {
                        const randomPrompt = surprisePrompts[Math.floor(Math.random() * surprisePrompts.length)];
                        setDailyPrompt(randomPrompt);
                        localStorage.setItem('vibevault_prompt_date', today);
                        localStorage.setItem('vibevault_daily_prompt', randomPrompt);
                    }
                }
            }, [isOpen]);
            
            if (!isOpen) return null;

            const handleNext = () => setStep(s => s + 1);
            const handleBack = () => setStep(s => Math.max(0, s - 1));
            const handleFinish = () => {
                const allFactors = [...data.weatherFactors, ...data.healthFactors];
                const finalData = {
                    mood: data.mood,
                    emotion: data.emotion,
                    anxiety: data.anxiety,
                    factors: allFactors,
                    note: data.note
                };
                onSave(finalData);
                onClose();
                setStep(0);
                setData({ mood: null, emotion: null, anxiety: null, weatherFactors: [], healthFactors: [], note: '' });
            };

            // Toggle weather and auto-advance if this is the first selection
            const toggleWeatherFactor = (fid) => {
                const wasEmpty = data.weatherFactors.length === 0;
                const weatherFactors = data.weatherFactors.includes(fid) 
                    ? data.weatherFactors.filter(f => f !== fid) 
                    : [...data.weatherFactors, fid];
                setData({ ...data, weatherFactors });
                if (wasEmpty && weatherFactors.length > 0) {
                    setTimeout(() => handleNext(), 300);
                }
            };

            // Toggle health and auto-advance if this is the first selection
            const toggleHealthFactor = (fid) => {
                const wasEmpty = data.healthFactors.length === 0;
                const healthFactors = data.healthFactors.includes(fid) 
                    ? data.healthFactors.filter(f => f !== fid) 
                    : [...data.healthFactors, fid];
                setData({ ...data, healthFactors });
                if (wasEmpty && healthFactors.length > 0) {
                    setTimeout(() => handleNext(), 300);
                }
            };

            // Auto-advance for single-select steps
            const selectAndAdvance = (field, value) => {
                setData({ ...data, [field]: value });
                setTimeout(() => handleNext(), 300);
            };

            // Voice dictate handler
            const handleVoiceInput = async () => {
                if (isRecording) {
                    recognitionRef.current?.stop();
                    setIsRecording(false);
                    return;
                }
                
                const permResult = await PermissionManager.requestMicrophone();
                if (!permResult.granted) {
                    alert('Microphone permission needed for voice input');
                    return;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("Speech recognition not supported in this browser.");
                    return;
                }
                
                const recognition = new SpeechRecognition();
                recognitionRef.current = recognition;
                recognition.lang = 'en-US';
                recognition.continuous = true;  // Enable continuous listening
                recognition.interimResults = true;  // Show interim results
                
                let finalTranscript = '';
                let silenceTimer = null;
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    
                    // Process all results
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Update the note with final transcript only (prevents duplication)
                    if (finalTranscript) {
                        setData(prev => {
                            const currentNote = prev.note;
                            // Only add if it's new content
                            if (!currentNote.includes(finalTranscript.trim())) {
                                return { ...prev, note: currentNote + (currentNote ? ' ' : '') + finalTranscript.trim() };
                            }
                            return prev;
                        });
                        finalTranscript = '';
                    }
                    
                    // Reset silence timer on any speech
                    if (silenceTimer) clearTimeout(silenceTimer);
                    
                    // Auto-stop after 2 seconds of silence
                    silenceTimer = setTimeout(() => {
                        if (recognitionRef.current && isRecording) {
                            recognitionRef.current.stop();
                        }
                    }, 2000);
                };
                
                recognition.onend = () => {
                    setIsRecording(false);
                    if (silenceTimer) clearTimeout(silenceTimer);
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    setIsRecording(false);
                    if (silenceTimer) clearTimeout(silenceTimer);
                };
                
                recognition.start();
                setIsRecording(true);
            };

            const totalSteps = 6;
            const progress = ((step + 1) / totalSteps) * 100;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[80] flex items-center justify-center p-4 animate-in">
                    <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-indigo-50/50">
                            <h3 className="font-extrabold text-indigo-900 text-lg">{t.wizardTitle}</h3>
                            <button onClick={onClose}><IconX className="w-5 h-5 text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto flex-1">
                            {/* STEP 0: MOOD */}
                            {step === 0 && (
                                <div className="space-y-4 animate-in">
                                    <h4 className="text-xl font-bold text-center text-slate-800">How are you feeling today?</h4>
                                    <div className="grid grid-cols-1 gap-3">
                                        {activeConfig.rateMyDay.levels.slice().reverse().map(l => (
                                            <button 
                                                key={l.value} 
                                                onClick={() => selectAndAdvance('mood', l.value)} 
                                                className="flex items-center gap-4 p-4 rounded-2xl border-2 border-slate-100 hover:border-indigo-200 hover:bg-indigo-50 transition-all group active:scale-95"
                                            >
                                                <div className="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white shadow-sm" style={{backgroundColor: l.defaultColor}}>{l.value}</div>
                                                <span className="font-bold text-slate-700 text-lg group-hover:text-indigo-700">{l.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* STEP 1: EMOTION */}
                            {step === 1 && (
                                <div className="space-y-4 animate-in">
                                    <h4 className="text-xl font-bold text-center text-slate-800">What emotion describes you?</h4>
                                    <div className="flex flex-wrap gap-2 justify-center">
                                        {activeConfig.emotions.levels.map(l => (
                                            <button 
                                                key={l.value} 
                                                onClick={() => selectAndAdvance('emotion', l.value)} 
                                                className="px-4 py-2 rounded-full border-2 font-bold text-sm transition-all active:scale-95 border-slate-100 bg-white text-slate-600 hover:border-indigo-200 hover:bg-indigo-50"
                                            >
                                                {l.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* STEP 2: ANXIETY */}
                            {step === 2 && (
                                <div className="space-y-4 animate-in">
                                    <h4 className="text-xl font-bold text-center text-slate-800">Anxiety level today?</h4>
                                    <div className="flex flex-col gap-3">
                                        {activeConfig.anxiety.levels.map(l => (
                                            <button 
                                                key={l.value} 
                                                onClick={() => selectAndAdvance('anxiety', l.value)} 
                                                className="p-4 rounded-2xl border-2 font-bold transition-all active:scale-95 border-slate-100 bg-white text-slate-600 hover:border-indigo-200 hover:bg-indigo-50"
                                            >
                                                {l.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* STEP 3: WEATHER */}
                            {step === 3 && (
                                <div className="space-y-4 animate-in">
                                    <h4 className="text-xl font-bold text-center text-slate-800">Weather today?</h4>
                                    <div className="flex flex-wrap gap-2 justify-center">
                                        {activeConfig.weather.levels.map(l => (
                                            <button 
                                                key={l.value} 
                                                onClick={() => toggleWeatherFactor(l.value)} 
                                                className={`px-3 py-2 rounded-xl border-2 text-sm font-bold transition-all active:scale-95 ${
                                                    data.weatherFactors.includes(l.value) 
                                                        ? 'border-blue-400 bg-blue-50 text-blue-700' 
                                                        : 'border-slate-100 text-slate-500 hover:border-blue-200'
                                                }`}
                                            >
                                                {l.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* STEP 4: HEALTH */}
                            {step === 4 && (
                                <div className="space-y-4 animate-in">
                                    <h4 className="text-xl font-bold text-center text-slate-800">How's your health?</h4>
                                    <div className="flex flex-wrap gap-2 justify-center">
                                        {activeConfig.health.levels.map(l => (
                                            <button 
                                                key={l.value} 
                                                onClick={() => toggleHealthFactor(l.value)} 
                                                className={`px-3 py-2 rounded-xl border-2 text-sm font-bold transition-all active:scale-95 ${
                                                    data.healthFactors.includes(l.value) 
                                                        ? 'border-green-400 bg-green-50 text-green-700' 
                                                        : 'border-slate-100 text-slate-500 hover:border-green-200'
                                                }`}
                                            >
                                                {l.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* STEP 5: QUICK NOTE */}
                            {step === 5 && (
                                <div className="space-y-4 animate-in">
                                    <h4 className="text-xl font-bold text-center text-slate-800">Quick Note</h4>
                                    
                                    {/* Daily Prompt Card */}
                                    {!data.note && (
                                        <div className="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-2xl p-4 animate-in">
                                            <div className="flex items-start gap-3">
                                                <div className="text-3xl">ðŸ’­</div>
                                                <div className="flex-1">
                                                    <div className="text-xs font-bold text-purple-600 uppercase tracking-wide mb-1">Today's Writing Prompt</div>
                                                    <div className="text-base font-medium text-slate-700 mb-2">{dailyPrompt}</div>
                                                    <div className="text-xs text-slate-500 italic">Tip: You can type or use voice dictate below! ðŸŽ™ï¸</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Helpful Tips (only when empty) */}
                                    {!data.note && (
                                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-3">
                                            <div className="text-xs font-bold text-blue-700 mb-2">ðŸ’¡ Quick Tips:</div>
                                            <ul className="text-xs text-slate-600 space-y-1">
                                                <li>â€¢ No pressure - write as much or as little as you want</li>
                                                <li>â€¢ Use the prompt above for inspiration</li>
                                                <li>â€¢ Try voice dictate for easier journaling</li>
                                                <li>â€¢ Your thoughts are private and safe here</li>
                                            </ul>
                                        </div>
                                    )}
                                    
                                    <SentimentInput
                                        value={data.note}
                                        onChange={(val) => setData({ ...data, note: val })}
                                        placeholder={dailyPrompt || "Type or speak..."}
                                    />
                                    
                                    <button
                                        onClick={handleVoiceInput}
                                        className={`w-full px-4 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
                                            isRecording 
                                                ? 'bg-red-500 text-white animate-pulse' 
                                                : 'bg-purple-500 text-white hover:bg-purple-600'
                                        }`}
                                    >
                                        <IconMic className="w-5 h-5" />
                                        {isRecording ? 'Listening...' : 'ðŸŽ™ï¸ Voice Dictate'}
                                    </button>
                                    
                                    {(data.weatherFactors.length > 0 || data.healthFactors.length > 0) && (
                                        <div className="flex flex-wrap gap-2">
                                            {[...data.weatherFactors, ...data.healthFactors].map(f => (
                                                <span key={f} className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500">{f}</span>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                            {step > 0 ? (
                                <button onClick={handleBack} className="text-slate-400 hover:text-slate-600 font-bold px-4 py-2">
                                    {t.back || 'Back'}
                                </button>
                            ) : <div></div>}
                            
                            {step < 5 ? (
                                <button onClick={handleNext} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all">
                                    {t.next || 'Next'}
                                </button>
                            ) : (
                                <button onClick={handleFinish} className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg shadow-green-200 transition-all">
                                    {t.wizardFinish || 'Save Entry'}
                                </button>
                            )}
                        </div>
                        
                        <div className="h-1 bg-slate-100 w-full">
                            <div className="h-full bg-indigo-500 transition-all duration-300" style={{width: `${progress}%`}}></div>
                        </div>
                    </div>
                </div>
            );
        };

        const RichInsightsChart = ({ data, colors }) => {
            const [hovered, setHovered] = useState(null);
            if (!data || Object.keys(data).length === 0) return <div className="text-center text-xs text-slate-400 py-8">No data yet</div>;
            const chartData = Object.entries(data).map(([key, value]) => ({ name: key, value })).sort((a,b) => b.value - a.value);
            const maxValue = Math.max(...chartData.map(d => d.value)) || 1;
            return (
                <div className="h-48 w-full flex items-end gap-2 pt-6 relative">
                    {chartData.map((item, idx) => {
                        const heightPct = (item.value / maxValue) * 100;
                        const color = colors[item.name] || '#818cf8';
                        return (
                            <div key={item.name} className="flex-1 flex flex-col items-center justify-end h-full group relative" onMouseEnter={() => setHovered(idx)} onMouseLeave={() => setHovered(null)}>
                                <div className={`absolute -top-8 bg-slate-800 text-white text-[10px] py-1 px-2 rounded opacity-0 transition-opacity whitespace-nowrap z-10 pointer-events-none ${hovered === idx ? 'opacity-100' : ''}`}>{item.name}: {item.value}</div>
                                <div className="w-full max-w-[24px] rounded-t-md transition-all duration-500 ease-out hover:brightness-110" style={{ height: `${heightPct}%`, backgroundColor: color, opacity: hovered === null || hovered === idx ? 1 : 0.6 }}></div>
                                <span className="text-[9px] mt-2 text-slate-500 font-bold truncate w-full text-center">{item.name}</span>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const BadgePanel = ({ streak, counts, theme }) => {
             const badges = [
                 { id: 'streak3', icon: 'ðŸ”¥', label: '3 Day Streak', earned: streak >= 3 },
                 { id: 'streak7', icon: 'ðŸš€', label: '7 Day Streak', earned: streak >= 7 },
                 { id: 'streak30', icon: 'ðŸ‘‘', label: 'Monthly Master', earned: streak >= 30 },
                 { id: 'movie5', icon: 'ðŸŽ¬', label: 'Movie Buff', earned: counts.movies >= 5 },
                 { id: 'song5', icon: 'ðŸŽ§', label: 'Melophile', earned: counts.songs >= 5 },
             ];
             return (
                 <div className={`mt-6 p-4 rounded-2xl ${theme.card} animate-slide-up`}>
                     <h3 className={`font-bold ${theme.text} mb-3 flex items-center gap-2 text-sm uppercase tracking-wider`}>Badges & Achievements</h3>
                     <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                         {badges.map(b => (
                             <div key={b.id} className={`flex flex-col items-center min-w-[80px] p-2 rounded-xl border ${b.earned ? 'bg-yellow-50 border-yellow-200 opacity-100' : 'bg-slate-50 border-slate-100 opacity-50 grayscale'}`}>
                                 <div className="text-2xl mb-1">{b.icon}</div>
                                 <div className="text-[9px] font-bold text-slate-600 text-center leading-tight">{b.label}</div>
                             </div>
                         ))}
                     </div>
                 </div>
             );
        };

        const SearchModal = ({ isOpen, onClose, results, onSelect, type }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[60] flex items-center justify-center p-6 animate-in">
                    <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm border-4 border-indigo-100 max-h-[80vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg text-slate-800">Select {type === 'movies' ? 'Movie' : 'Song'}</h3>
                            <button onClick={onClose}><IconX className="w-5 h-5 text-slate-400" /></button>
                        </div>
                        <div className="space-y-3">
                            {results.map((item) => (
                                <div key={item.id} onClick={() => onSelect(item)} className="flex gap-3 p-2 rounded-xl hover:bg-indigo-50 cursor-pointer border border-transparent hover:border-indigo-100 transition-all">
                                    <img src={item.image || 'https://via.placeholder.com/50'} className="w-12 h-16 object-cover rounded-md bg-slate-200" />
                                    <div className="flex flex-col justify-center">
                                        <h4 className="font-bold text-sm text-slate-800 line-clamp-1">{item.title}</h4>
                                        <p className="text-xs text-slate-500">{item.subtitle}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ColorEditor = ({ isOpen, onClose, level, currentColor, onSave }) => {
          const [selectedColor, setSelectedColor] = useState(currentColor);
          useEffect(() => setSelectedColor(currentColor), [currentColor]);
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm animate-pop border-4 border-indigo-100">
                <h3 className="text-xl font-bold text-slate-800 mb-6 text-center">Pick a color for <br/><span className="text-indigo-600">"{level.label}"</span></h3>
                <div className="flex flex-col gap-6">
                  <label className="flex items-center gap-4 p-4 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                    <input type="color" value={selectedColor} onChange={(e) => setSelectedColor(e.target.value)} className="w-12 h-12 rounded-xl cursor-pointer border-0 p-0 shadow-sm" />
                    <div className="flex flex-col"><span className="font-mono text-slate-600 font-bold text-lg uppercase">{selectedColor}</span><span className="text-xs text-slate-400 font-bold">Tap swatch to change</span></div>
                  </label>
                  <div className="flex gap-3 justify-center mt-2">
                    <button onClick={onClose} className="px-6 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors">Cancel</button>
                    <button onClick={() => { onSave(level.value, selectedColor); onClose(); }} className="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold rounded-xl hover:shadow-lg hover:scale-105 transition-all">Save Color</button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const MonthlyStatsModal = ({ monthIndex, year, data, config, colors, onClose, t, theme }) => {
            const monthName = t.months[monthIndex];
            const stats = useMemo(() => {
                const counts = {}; let total = 0;
                for (let d = 1; d <= 31; d++) {
                    const val = data[`${monthIndex}-${d}`];
                    if (val) { counts[val] = (counts[val] || 0) + 1; total++; }
                }
                const chartData = Object.entries(counts).map(([label, count]) => ({
                    label: config.levels.find(l => l.value == label)?.label || label,
                    value: count, color: colors[label] || '#cbd5e1'
                })).sort((a, b) => b.value - a.value);
                return { chartData, total };
            }, [data, monthIndex, config, colors]);

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-6 animate-in">
                    <div className={`bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm border-4 border-indigo-100 relative max-h-[80vh] overflow-y-auto ${theme.font}`}>
                        <div className="flex justify-between items-center mb-6">
                             <h2 className="text-2xl font-extrabold text-indigo-600">{monthName} {year}</h2>
                             <button onClick={onClose}><IconX className="w-5 h-5 text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        {stats.total === 0 ? <div className="text-center py-8 text-slate-400 italic">No data recorded.</div> : (
                            <div className="space-y-4">
                                {stats.chartData.map((item, idx) => (
                                    <div key={idx} className="flex items-center gap-3">
                                        <div className="w-3 h-3 rounded-full shrink-0" style={{backgroundColor: item.color}}></div>
                                        <div className="flex-1">
                                            <div className="flex justify-between text-xs font-bold text-slate-700 mb-1"><span>{item.label}</span><span>{Math.round((item.value/stats.total)*100)}% ({item.value})</span></div>
                                            <div className="w-full bg-slate-100 rounded-full h-2 overflow-hidden"><div className="h-full rounded-full transition-all duration-1000" style={{width: `${(item.value/stats.total)*100}%`, backgroundColor: item.color}}></div></div>
                                        </div>
                                    </div>
                                ))}
                                <div className="mt-4 pt-4 border-t border-slate-100 text-center text-xs text-slate-400 font-bold uppercase tracking-widest">Total Days: {stats.total}</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const DataModal = ({ onClose, t, onExport, onImport }) => {
            const fileInputRef = useRef(null);
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    onImport(file);
                }
            };
            return (
                 <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-6 animate-in">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm border-4 border-indigo-100 relative">
                        <div className="text-center mb-6 relative z-10">
                            <h2 className="text-2xl font-extrabold text-indigo-600 mb-2">{t.dataMgmt}</h2>
                            <button onClick={onClose} className="absolute top-0 right-0 p-2"><IconX className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <div className="space-y-4">
                            <button onClick={onExport} className="w-full py-4 bg-indigo-50 border border-indigo-100 text-indigo-700 font-bold rounded-xl hover:bg-indigo-100 flex items-center justify-center gap-2"><IconDownload className="w-5 h-5" /> {t.exportData}</button>
                            <div className="relative">
                                <button onClick={() => fileInputRef.current.click()} className="w-full py-4 bg-slate-50 border border-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-100 flex items-center justify-center gap-2"><IconUpload className="w-5 h-5" /> {t.importData}</button>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json" className="hidden" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const HelpModal = ({ onClose, t }) => (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-6 animate-in">
                <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg border-4 border-indigo-100 relative max-h-[90vh] overflow-y-auto">
                    <div className="text-center mb-6 relative z-10"><h2 className="text-3xl font-extrabold text-indigo-600 mb-2">{t.helpTitle}</h2><button onClick={onClose} className="absolute top-0 right-0 p-2 text-slate-400">âœ•</button></div>
                    <div className="space-y-4">{(t.features || []).map((f, i) => (<div key={i} className="flex gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><div className="text-2xl">{f.icon}</div><div><h4 className="font-bold text-indigo-700 text-sm">{f.title}</h4><p className="text-xs text-slate-600">{f.desc}</p></div></div>))}</div>
                    <button onClick={onClose} className="w-full py-3 bg-indigo-500 text-white font-bold rounded-xl mt-6 hover:bg-indigo-600">Got it!</button>
                </div>
            </div>
        );

        // Simple hash function for PIN (basic security from siblings)
        const hashPin = (pin) => {
            let hash = 0;
            for (let i = 0; i < pin.length; i++) {
                const char = pin.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        };

        // PIN Lock Screen Component
        const PinLockScreen = ({ onUnlock, theme, t }) => {
            const [pin, setPin] = useState('');
            const [error, setError] = useState(false);
            const [shakeError, setShakeError] = useState(false);
            
            useEffect(() => {
                if (pin.length === 4) {
                    const storedHash = localStorage.getItem('vibevault_pin_hash');
                    const enteredHash = hashPin(pin);
                    
                    if (enteredHash === storedHash) {
                        // Correct PIN
                        onUnlock();
                    } else {
                        // Wrong PIN
                        setError(true);
                        setShakeError(true);
                        setTimeout(() => {
                            setPin('');
                            setError(false);
                            setShakeError(false);
                        }, 500);
                    }
                }
            }, [pin, onUnlock]);
            
            const handleNumberClick = (num) => {
                if (pin.length < 4) {
                    setPin(pin + num);
                }
            };
            
            const handleBackspace = () => {
                setPin(pin.slice(0, -1));
            };
            
            return (
                <div className={`min-h-screen flex items-center justify-center ${theme.bg} p-4`}>
                    <div className="w-full max-w-md">
                        <div className="text-center mb-12 animate-in">
                            <div className="w-24 h-24 bg-white/90 backdrop-blur-md rounded-3xl shadow-2xl flex items-center justify-center border-4 border-white mx-auto mb-6">
                                <span className="text-5xl">ðŸ”’</span>
                            </div>
                            <h1 className="text-4xl font-extrabold mb-2 text-white drop-shadow-lg">VibeVault</h1>
                            <p className="text-white/80 font-medium">{t?.enterPin || "Enter your 4-digit PIN"}</p>
                        </div>
                        
                        {/* PIN Display */}
                        <div className={`flex justify-center gap-4 mb-8 ${shakeError ? 'animate-shake' : ''}`}>
                            {[0, 1, 2, 3].map(i => (
                                <div
                                    key={i}
                                    className={`w-16 h-16 rounded-2xl flex items-center justify-center text-3xl font-bold transition-all ${
                                        pin.length > i
                                            ? error
                                                ? 'bg-red-500 text-white shadow-lg shadow-red-200'
                                                : 'bg-white text-indigo-600 shadow-lg shadow-indigo-200'
                                            : 'bg-white/20 backdrop-blur border-2 border-white/50'
                                    }`}
                                >
                                    {pin.length > i ? 'â—' : ''}
                                </div>
                            ))}
                        </div>
                        
                        {error && (
                            <div className="text-center mb-4 text-red-100 font-bold animate-in">
                                {t?.incorrectPin || "âŒ Incorrect PIN. Try again!"}
                            </div>
                        )}
                        
                        {/* Number Pad */}
                        <div className="bg-white/10 backdrop-blur-md rounded-3xl p-6 border border-white/30">
                            <div className="grid grid-cols-3 gap-4 mb-4">
                                {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                                    <button
                                        key={num}
                                        onClick={() => handleNumberClick(num.toString())}
                                        className="aspect-square bg-white/90 hover:bg-white rounded-2xl text-2xl font-bold text-slate-700 shadow-lg hover:shadow-xl transition-all hover:scale-105 active:scale-95"
                                    >
                                        {num}
                                    </button>
                                ))}
                            </div>
                            <div className="grid grid-cols-3 gap-4">
                                <div></div>
                                <button
                                    onClick={() => handleNumberClick('0')}
                                    className="aspect-square bg-white/90 hover:bg-white rounded-2xl text-2xl font-bold text-slate-700 shadow-lg hover:shadow-xl transition-all hover:scale-105 active:scale-95"
                                >
                                    0
                                </button>
                                <button
                                    onClick={handleBackspace}
                                    className="aspect-square bg-white/70 hover:bg-white/90 rounded-2xl flex items-center justify-center shadow-lg hover:shadow-xl transition-all hover:scale-105 active:scale-95"
                                >
                                    <IconX className="w-6 h-6 text-slate-700" />
                                </button>
                            </div>
                        </div>
                        
                        <div className="text-center mt-6 text-white/60 text-sm">
                            Your privacy matters ðŸ”
                        </div>
                    </div>
                </div>
            );
        };

        const ProfileModal = ({ initialData, onComplete, onClose, t, activeConfig }) => {
            const [name, setName] = useState(initialData?.name || '');
            const [age, setAge] = useState(initialData?.age || '');
            const [avatar, setAvatar] = useState(initialData?.avatar || null);
            const [location, setLocation] = useState(initialData?.location || '');
            const [language, setLanguage] = useState(initialData?.language || 'en');
            const [theme, setTheme] = useState(initialData?.theme || 'playful'); 
            const [omdbKey, setOmdbKey] = useState(initialData?.omdbKey || '642f2e77');
            const [pin, setPin] = useState('');
            const [showCustomization, setShowCustomization] = useState(false);
            const currentDefaults = useMemo(() => getTrackerConfigs(language), [language]);
            const [customLabels, setCustomLabels] = useState(activeConfig || currentDefaults);
            const [enabledTrackers, setEnabledTrackers] = useState(initialData?.enabledTrackers || Object.keys(currentDefaults));
            
            useEffect(() => { setCustomLabels(currentDefaults); }, [language, currentDefaults]);
            const fileInputRef = useRef(null);
            // Safe fallback for currentT if language switches before reload
            const currentT = TRANSLATIONS[language] || TRANSLATIONS['en'];

            const handleDetectLocation = () => { 
                if (navigator.geolocation) {
                    setLocation("Detecting...");
                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        try {
                            const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=en`);
                            const data = await res.json();
                            setLocation(`${data.city || data.locality || ''}, ${data.countryName || ''}`);
                        } catch (e) { setLocation(`${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`); }
                    }, () => setLocation("Location Error"));
                } else { setLocation("Not Supported"); }
            }; 

            const handleLabelChange = (trackerId, levelValue, newLabel) => {
                setCustomLabels(prev => ({ ...prev, [trackerId]: { ...prev[trackerId], levels: prev[trackerId].levels.map(l => l.value === levelValue ? { ...l, label: newLabel } : l) } }));
            };

            const toggleTracker = (tid) => {
                if (enabledTrackers.includes(tid)) {
                    setEnabledTrackers(enabledTrackers.filter(id => id !== tid));
                } else {
                    setEnabledTrackers([...enabledTrackers, tid]);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-6 animate-in">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border-4 border-indigo-100 relative overflow-hidden max-h-[90vh] overflow-y-auto font-sans">
                        <div className="text-center mb-6 relative z-10"><h2 className="text-3xl font-extrabold text-indigo-600 mb-2">{currentT.setupTitle}</h2>{onClose && <button onClick={onClose} className="absolute top-0 right-0 p-2 text-slate-400">âœ•</button>}</div>
                        <form onSubmit={(e) => { 
                            e.preventDefault(); 
                            if(name.trim()) {
                                // Handle PIN: save hash if 4 digits, remove if empty
                                if (pin && pin.length === 4) {
                                    localStorage.setItem('vibevault_pin_hash', hashPin(pin));
                                } else if (!pin) {
                                    localStorage.removeItem('vibevault_pin_hash');
                                }
                                onComplete({ name, age, avatar, location, language, theme, omdbKey, customLabels, enabledTrackers });
                            }
                        }} className="space-y-4">
                            <div className="flex flex-col items-center">
                                <div onClick={() => fileInputRef.current.click()} className="w-24 h-24 rounded-full bg-slate-100 border-4 border-white shadow-lg flex items-center justify-center cursor-pointer overflow-hidden group relative">
                                    {avatar ? <img src={avatar} className="w-full h-full object-cover" /> : <IconUser className="w-10 h-10 text-slate-400" />}
                                    <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100"><IconCamera className="w-6 h-6 text-white" /></div>
                                </div>
                                <span className="text-xs text-slate-400 mt-1">{currentT.uploadPhoto}</span>
                                <input type="file" ref={fileInputRef} onChange={async (e) => { if(e.target.files[0]) setAvatar(await compressImage(e.target.files[0])); }} className="hidden" accept="image/*" />
                            </div>
                            
                            <div><label className="block text-sm font-bold text-slate-700 mb-1 ml-1">{currentT.languageLabel}</label><select value={language} onChange={(e) => setLanguage(e.target.value)} className="w-full px-4 py-2 rounded-xl border-2 border-slate-200 focus:border-indigo-400 outline-none font-bold text-slate-700"><option value="en">English</option><option value="pl">Polski</option><option value="fr">FranÃ§ais</option><option value="es">EspaÃ±ol</option></select></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1 ml-1">{currentT.nameLabel}</label><input required value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-2 rounded-xl border-2 border-slate-200 focus:border-indigo-400 outline-none font-bold text-slate-700" /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1 ml-1">{currentT.ageLabel}</label><input type="number" value={age} onChange={(e) => setAge(e.target.value)} className="w-full px-4 py-2 rounded-xl border-2 border-slate-200 focus:border-indigo-400 outline-none font-bold text-slate-700" /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1 ml-1">{currentT.locationLabel}</label><div className="flex gap-2"><input value={location} onChange={(e) => setLocation(e.target.value)} className="w-full px-4 py-2 rounded-xl border-2 border-slate-200 focus:border-indigo-400 outline-none font-bold text-slate-700" /><button type="button" onClick={handleDetectLocation} className="px-3 bg-indigo-100 text-indigo-600 rounded-xl font-bold"><IconMap className="w-4 h-4" /></button></div></div>
                            
                            {/* Privacy Lock PIN */}
                            <div className="bg-purple-50 border-2 border-purple-200 rounded-2xl p-4">
                                <label className="block text-sm font-bold text-purple-700 mb-2 flex items-center gap-2">
                                    <span>ðŸ”’</span> {t.pinLock || "Privacy Lock PIN (Optional)"}
                                </label>
                                <input 
                                    type="password" 
                                    maxLength="4"
                                    value={pin} 
                                    onChange={(e) => setPin(e.target.value.replace(/\D/g, ''))}
                                    placeholder="Enter 4-digit PIN"
                                    className="w-full px-4 py-2 rounded-xl border-2 border-purple-200 focus:border-purple-400 outline-none font-bold text-slate-700 text-center text-2xl tracking-widest"
                                />
                                <p className="text-xs text-slate-600 mt-2">
                                    {t.pinHelper || "ðŸ’¡ Set a 4-digit PIN to lock your diary. Leave empty to disable lock."}
                                </p>
                                {pin && pin.length !== 4 && (
                                    <p className="text-xs text-orange-600 mt-1 font-bold">
                                        {t.pinWarning || "âš ï¸ PIN must be exactly 4 digits"}
                                    </p>
                                )}
                                {pin && pin.length === 4 && (
                                    <p className="text-xs text-green-600 mt-1 font-bold">
                                        {t.pinReady || "âœ… PIN ready! Your diary will be locked."}
                                    </p>
                                )}
                            </div>
                            
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-1 ml-1">{currentT.manageTrackers}</label>
                                <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto p-2 border-2 border-slate-100 rounded-xl bg-slate-50">
                                    {Object.keys(currentDefaults).map(tid => (
                                        <label key={tid} className="flex items-center gap-2 cursor-pointer p-2 hover:bg-white rounded-lg transition-colors border border-transparent hover:border-slate-100">
                                            <input 
                                                type="checkbox" 
                                                checked={enabledTrackers.includes(tid)} 
                                                onChange={() => toggleTracker(tid)}
                                                className="accent-indigo-500 w-4 h-4 rounded cursor-pointer"
                                            />
                                            <span className="text-xs font-bold text-slate-600 truncate">{currentT.trackers[tid].title}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>

                            <div><label className="block text-sm font-bold text-slate-700 mb-1 ml-1">{currentT.themeLabel}</label><div className="grid grid-cols-3 gap-2">{Object.values(THEMES).map(th => (<button key={th.id} type="button" onClick={() => setTheme(th.id)} className={`px-2 py-2 rounded-xl border-2 font-bold text-xs ${theme === th.id ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-100 text-slate-500'}`}>{th.label}</button>))}</div></div>

                            <div className="border-t border-slate-100 pt-4 mt-2">
                                <button type="button" onClick={() => setShowCustomization(!showCustomization)} className="flex items-center justify-between w-full text-left text-sm font-bold text-indigo-600 bg-indigo-50 px-4 py-3 rounded-xl hover:bg-indigo-100 transition-colors"><span>{currentT.customizeTitle}</span><IconChevronDown className={`w-4 h-4 transition-transform ${showCustomization ? 'rotate-180' : ''}`} /></button>
                                {showCustomization && (
                                    <div className="mt-2 space-y-4 pl-2 border-l-2 border-indigo-100 ml-2">
                                        <p className="text-xs text-slate-400 italic mb-2">{currentT.customizeDesc}</p>
                                        {Object.values(customLabels).filter(c => c.type === 'pixel').map(tracker => (
                                            <div key={tracker.id} className="space-y-2">
                                                <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wide">{currentT.trackers[tracker.id].title}</h4>
                                                <div className="grid grid-cols-2 gap-2">{tracker.levels.map(level => (<div key={level.value} className="flex items-center gap-2"><div className="w-3 h-3 rounded-full shrink-0" style={{backgroundColor: level.defaultColor}}></div><input type="text" value={level.label} onChange={(e) => handleLabelChange(tracker.id, level.value, e.target.value)} className="w-full text-xs border-b border-slate-200 focus:border-indigo-400 outline-none py-1 bg-transparent text-slate-700" /></div>))}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <button type="submit" className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-extrabold rounded-xl shadow-lg mt-4">{initialData ? currentT.save : currentT.letsGo}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const TravelMapView = ({ config, data, onUpdateData, t, userProfile }) => {
            const mapRef = useRef(null);
            const [inputValue, setInputValue] = useState('');
            const [monthIndex, setMonthIndex] = useState(new Date().getMonth());

            // Initialize Map
            useEffect(() => {
                if (!mapRef.current) {
                    mapRef.current = L.map('travel-map').setView([20, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapRef.current);
                }
                
                // Clear existing markers
                mapRef.current.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        mapRef.current.removeLayer(layer);
                    }
                });

                // Add markers for all cities in data
                Object.values(data).forEach(entries => {
                    if (Array.isArray(entries)) {
                        entries.forEach(entry => {
                            if (entry.meta && entry.meta.lat && entry.meta.lon) {
                                L.marker([entry.meta.lat, entry.meta.lon])
                                 .addTo(mapRef.current)
                                 .bindPopup(`<b>${entry.text}</b><br>${new Date(entry.timestamp).toLocaleDateString()}`);
                            }
                        });
                    }
                });
            }, [data]);

            const handleAddCity = async () => {
                if (!inputValue.trim()) return;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(inputValue)}`);
                    const json = await res.json();
                    if (json && json.length > 0) {
                        const loc = json[0];
                        const meta = { lat: parseFloat(loc.lat), lon: parseFloat(loc.lon) };
                        const newEntry = { id: generateId(), text: inputValue, meta: meta, timestamp: Date.now() };
                        const key = monthIndex.toString();
                        const currentEntries = Array.isArray(data[key]) ? data[key] : [];
                        onUpdateData(key, [...currentEntries, newEntry]);
                        setInputValue('');
                    } else { alert("City not found."); }
                } catch (e) { alert("Error finding city."); }
            };

            return (
                <div className="flex-1 flex flex-col h-full bg-white/50 backdrop-blur-md overflow-hidden">
                    <div className="h-1/2 w-full p-4">
                        <div id="travel-map" className="w-full h-full rounded-2xl shadow-lg border-2 border-white"></div>
                    </div>
                    <div className="flex-1 p-4 overflow-y-auto">
                        <div className="flex gap-2 mb-4">
                             <select value={monthIndex} onChange={(e) => setMonthIndex(parseInt(e.target.value))} className="p-2 rounded-xl border-none font-bold text-slate-600 bg-white shadow-sm outline-none">
                                {t.months.map((m, i) => <option key={i} value={i}>{m}</option>)}
                             </select>
                             <input type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} placeholder="Add City..." className="flex-1 p-2 rounded-xl border-none shadow-sm outline-none pl-4" onKeyDown={(e) => e.key === 'Enter' && handleAddCity()} />
                             <button onClick={handleAddCity} className="p-2 bg-indigo-500 text-white rounded-xl shadow-md hover:bg-indigo-600 transition-colors"><IconPlus className="w-5 h-5"/></button>
                        </div>
                        <div className="space-y-2">
                             {(data[monthIndex.toString()] || []).map(entry => (
                                 <div key={entry.id} className="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm animate-in">
                                     <span className="font-bold text-slate-700">{entry.text}</span>
                                     <button onClick={() => { if(confirm("Remove?")) onUpdateData(monthIndex.toString(), data[monthIndex.toString()].filter(e => e.id !== entry.id)); }} className="text-red-400 hover:text-red-600"><IconX className="w-4 h-4"/></button>
                                 </div>
                             ))}
                             {(!data[monthIndex.toString()] || data[monthIndex.toString()].length === 0) && <div className="text-center text-slate-400 italic text-sm mt-4">No travels this month.</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const LocationLogView = ({ config, data, onUpdateData, t }) => {
            const todayKey = new Date().toLocaleDateString('en-CA'); 
            const [loading, setLoading] = useState(false);

            const handleCheckIn = () => {
                if (data[todayKey]) { alert("Already checked in today!"); return; }
                setLoading(true);
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        try {
                            const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=en`);
                            const json = await res.json();
                            const locationName = `${json.city || json.locality}, ${json.countryName}`;
                            const newData = { ...data, [todayKey]: { text: locationName, timestamp: Date.now() } };
                            onUpdateData(newData);
                        } catch (e) { alert("Could not get address."); }
                        setLoading(false);
                    }, () => { alert("Location permission denied."); setLoading(false); });
                } else { alert("Not supported."); setLoading(false); }
            };

            const sortedEntries = Object.entries(data).sort((a, b) => new Date(b[0]) - new Date(a[0]));
            return (
                <div className="flex-1 flex flex-col p-6 bg-white/50 backdrop-blur-md overflow-hidden">
                    <div className="text-center mb-6">
                        <button onClick={handleCheckIn} disabled={!!data[todayKey] || loading} className={`w-full py-6 rounded-3xl shadow-xl font-extrabold text-xl flex items-center justify-center gap-3 transition-all transform hover:scale-[1.02] active:scale-95 ${data[todayKey] ? 'bg-green-100 text-green-600 cursor-default' : 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white hover:shadow-2xl'}`}>{loading ? "Locating..." : (data[todayKey] ? <span><IconMap className="w-6 h-6"/> {t.checkedIn}</span> : <span><IconMap className="w-6 h-6"/> {t.checkIn}</span>)}</button>
                        {data[todayKey] && <p className="mt-2 text-sm font-bold text-green-600 animate-in">ðŸ“ {data[todayKey].text}</p>}
                    </div>
                    <div className="flex-1 overflow-y-auto bg-white/60 rounded-3xl p-4 shadow-inner">
                        <h3 className="font-bold text-slate-500 uppercase text-xs mb-4 sticky top-0 bg-white/0 backdrop-blur-sm py-2">{t.locationLog}</h3>
                        <div className="space-y-3">
                            {sortedEntries.map(([date, entry]) => (
                                <div key={date} className="flex gap-4 items-center p-3 bg-white rounded-2xl shadow-sm border border-slate-100">
                                    <div className="flex flex-col items-center justify-center bg-indigo-50 text-indigo-600 w-14 h-14 rounded-xl font-bold leading-tight"><span className="text-xs uppercase">{new Date(date).toLocaleString('default', {month:'short'})}</span><span className="text-lg">{new Date(date).getDate()}</span></div>
                                    <div><div className="font-bold text-slate-800 text-sm">{entry.text}</div><div className="text-xs text-slate-400 font-mono">{new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div></div>
                                </div>
                            ))}
                            {sortedEntries.length === 0 && <div className="text-center text-slate-400 italic mt-10">No logs yet.</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const VibeLabModal = ({ isOpen, onClose, t, stats, theme }) => {
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);
            
            const insights = useMemo(() => {
                if (!stats) return [];
                const res = [];
                if (stats.rateMyDay) {
                    const topMood = Object.entries(stats.rateMyDay).sort((a,b) => b[1]-a[1])[0];
                    if (topMood) res.push({ icon: 'âœ¨', text: `Your dominant mood is ${topMood[0]}.` });
                }
                if (stats.travel > 0) res.push({ icon: 'ðŸŒ', text: `Travel seems to boost your logging frequency!` });
                return res;
            }, [stats]);

            useEffect(() => {
                if (!isOpen || !chartRef.current || !stats?.rateMyDay) return;
                
                // Only create chart once when modal opens
                if (!chartInstanceRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    chartInstanceRef.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(stats.rateMyDay),
                            datasets: [{
                                data: Object.values(stats.rateMyDay),
                                backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e']
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: true,
                            plugins: { legend: { position: 'bottom' } },
                            animation: { duration: 0 }
                        }
                    });
                }
                
                // Cleanup when modal closes
                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                        chartInstanceRef.current = null;
                    }
                };
            }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[70] flex items-center justify-center p-6 animate-in">
                    <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-2xl border-4 border-indigo-100 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-extrabold text-indigo-600 flex items-center gap-2"><IconFlask className="w-6 h-6"/> {t.vibeLab}</h2>
                            <button onClick={onClose}><IconX className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                                <h3 className="font-bold text-indigo-800 mb-3 text-sm uppercase">AI Pattern Detection</h3>
                                <div className="space-y-3">
                                    {insights.length > 0 ? insights.map((i, idx) => (
                                        <div key={idx} className="bg-white p-3 rounded-xl shadow-sm flex gap-3 items-center">
                                            <span className="text-xl">{i.icon}</span>
                                            <p className="text-sm font-medium text-slate-700">{i.text}</p>
                                        </div>
                                    )) : <p className="text-sm text-slate-500 italic">Not enough data to find patterns yet.</p>}
                                </div>
                            </div>
                            <div className="flex flex-col items-center justify-center">
                                <canvas ref={chartRef}></canvas>
                                <p className="text-xs text-slate-400 mt-4 text-center">Mood Distribution Analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TrackerHeader = ({ config, onBack, userAvatar, onReset, progress, year, onYearChange, t, onNext, onPrev, onAvatarClick, onOpenSettings }) => (
            <div className="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-white/50 px-4 py-3 flex items-center justify-between shadow-sm gap-2 sm:gap-4 transition-all">
                <div className="flex items-center gap-2 sm:gap-3 shrink-0"><button onClick={onBack} className="p-2 bg-white hover:bg-white/80 hover:scale-110 shadow-sm rounded-full transition-all text-indigo-600"><IconArrowLeft className="w-5 h-5" /></button><div><div className="flex items-center gap-2">{onPrev && <button onClick={onPrev} className="p-1 text-indigo-400 hover:text-indigo-600"><IconChevronLeft className="w-4 h-4" /></button>}<h2 className="font-bold text-slate-800 leading-tight text-base sm:text-lg">{t.trackers[config.id].title}</h2>{onNext && <button onClick={onNext} className="p-1 text-indigo-400 hover:text-indigo-600"><IconChevronRight className="w-4 h-4" /></button>}<span className="hidden sm:inline-block text-[10px] font-bold text-white bg-indigo-500 px-2 py-0.5 rounded-full uppercase tracking-wider shadow-sm">JiyaZee</span></div><p className="text-xs text-slate-500 hidden md:block font-medium">{t.trackers[config.id].desc}</p></div></div>
                <div className="flex-1 flex flex-col items-center justify-center max-w-[200px]"><div className="flex items-center gap-2 bg-slate-100/80 rounded-full px-2 py-1 mb-1 shadow-inner"><button onClick={() => onYearChange(year - 1)} disabled={year <= 2021} className="p-1 text-indigo-500"><IconChevronLeft className="w-4 h-4" /></button><span className="text-sm font-extrabold text-slate-700 w-10 text-center">{year}</span><button onClick={() => onYearChange(year + 1)} disabled={year >= 2030} className="p-1 text-indigo-500"><IconChevronRight className="w-4 h-4" /></button></div>{progress !== undefined && (<div className="w-full flex items-center gap-2"><div className="w-full bg-slate-200 rounded-full h-1.5 overflow-hidden"><div className="bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 h-full rounded-full transition-all duration-1000 ease-out" style={{ width: `${progress}%` }}></div></div><span className="text-[9px] font-bold text-indigo-400 w-6 text-right">{progress}%</span></div>)}</div>
                <div className="flex items-center gap-2 shrink-0"><button onClick={onReset} className="p-2 bg-white/50 hover:bg-red-50 hover:text-red-500 rounded-full transition-all text-slate-400"><IconTrash className="w-4 h-4" /></button>{userAvatar && <button onClick={onOpenSettings} className="p-0 bg-transparent border-0"><img src={userAvatar} className="w-8 h-8 rounded-full border border-slate-200 shadow-sm object-cover cursor-pointer hover:ring-2 hover:ring-indigo-400 transition-all" /></button>}</div>
            </div>
        );

        const WeatherWidget = ({ location, t }) => {
             const [forecast, setForecast] = useState([]);
             useEffect(() => { if (navigator.geolocation) navigator.geolocation.getCurrentPosition((pos) => fetchWeatherForecast(pos.coords.latitude, pos.coords.longitude).then(setForecast), () => fetchWeatherForecast(51.5074, -0.1278).then(setForecast)); }, []);
             if (forecast.length === 0) return null;
             return (<div className="shrink-0 p-4 border-b border-white/50 bg-white/40 overflow-x-auto no-scrollbar"><h3 className="text-xs font-bold text-indigo-800 mb-2 uppercase tracking-wide flex items-center gap-2"><IconCloudRain className="w-4 h-4 text-blue-500" /> {t.forecast}</h3><div className="flex gap-4 min-w-max justify-center">{forecast.map((day, idx) => (<div key={idx} className="flex flex-col items-center bg-white/60 p-2 rounded-xl min-w-[70px] border border-white/50"><span className="text-[10px] font-bold text-slate-600 uppercase">{day.day}</span><span className="text-2xl my-1">{day.icon}</span><div className="flex gap-1 text-[10px] font-mono"><span className="text-red-400 font-bold">{day.max}Â°</span><span className="text-slate-300">/</span><span className="text-blue-400 font-bold">{day.min}Â°</span></div></div>))}</div></div>);
        };

        const NotesView = ({ config, data, onUpdateData, year, t, userProfile }) => {
            const isWeekly = config.type === 'weekly_notes';
            const items = isWeekly ? WEEKS : MONTHS;
            const [listeningId, setListeningId] = useState(null);
            const [localInputs, setLocalInputs] = useState({}); 
            const [trending, setTrending] = useState([]);
            const [trendingLoading, setTrendingLoading] = useState(false);
            const [trendingOffset, setTrendingOffset] = useState(0);
            const [searchResults, setSearchResults] = useState([]);
            const [searchModalOpen, setSearchModalOpen] = useState(false);
            const [searchActiveKey, setSearchActiveKey] = useState(null);
            const [addedId, setAddedId] = useState(null); 
            const recognitionRef = useRef(null);
            const hasLoadedInitial = useRef(false);
            
            useEffect(() => { 
                if (config.id === 'movies' || config.id === 'songs') {
                    // Only load on first mount or when config changes, not on every render
                    if (!hasLoadedInitial.current) {
                        hasLoadedInitial.current = true;
                        setTrendingLoading(true);
                        fetchTrending(config.id, getCountryCode(userProfile?.location)).then(d => {
                            setTrending(d.slice(0, 5));
                            setTrendingLoading(false);
                        }).catch(() => {
                            setTrendingLoading(false);
                        });
                    }
                } else {
                    setTrending([]);
                    hasLoadedInitial.current = false;
                }
            }, [config.id]);
            
            const loadMoreTrending = async () => {
                setTrendingLoading(true);
                const newOffset = trendingOffset + 5;
                const allResults = await fetchTrending(config.id, getCountryCode(userProfile?.location));
                const newBatch = allResults.slice(newOffset, newOffset + 5);
                
                if (newBatch.length > 0) {
                    setTrending(newBatch);
                    setTrendingOffset(newOffset);
                } else {
                    // No more content - keep current recommendations
                    alert('No more recommendations available. Click Refresh to see the first batch again.');
                }
                setTrendingLoading(false);
            };
            
            const refreshTrending = async () => {
                setTrendingLoading(true);
                setTrendingOffset(0);
                const allResults = await fetchTrending(config.id, getCountryCode(userProfile?.location));
                setTrending(allResults.slice(0, 5));
                setTrendingLoading(false);
            };

            const handleSpeech = async (key) => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) { alert("Dictation not supported in this browser."); return; }
                if (listeningId === key) { recognitionRef.current?.stop(); return; }
                if (listeningId) recognitionRef.current?.abort();
                try {
                    const recognition = new SpeechRecognition();
                    recognitionRef.current = recognition;
                    recognition.lang = userProfile?.language === 'pl' ? 'pl-PL' : userProfile?.language === 'fr' ? 'fr-FR' : userProfile?.language === 'es' ? 'es-ES' : 'en-US';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;
                    setListeningId(key);
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        const existing = localInputs[key] || '';
                        setLocalInputs(prev => ({ ...prev, [key]: existing ? `${existing} ${transcript}` : transcript }));
                    };
                    recognition.onend = () => { setListeningId(null); recognitionRef.current = null; };
                    recognition.start();
                } catch (err) { setListeningId(null); }
            };

            const handleAddEntry = async (key, text, meta = null) => {
                if (!text && !meta) return;
                const newEntry = { id: generateId(), text: text || '', meta: meta || null, timestamp: Date.now() };
                onUpdateData(key, [...(Array.isArray(data[key]) ? data[key] : (data[key] ? [data[key]] : [])), newEntry]);
                setLocalInputs(p => ({ ...p, [key]: '' }));
            };
            
            const handleAddTrending = (item, idx) => {
                handleAddEntry((new Date().getMonth()).toString(), "", item.meta);
                setAddedId(idx);
                setTimeout(() => setAddedId(null), 1500);
            };

            const handleMagic = async (key) => {
                const query = localInputs[key];
                if (!query) return;
                const results = await searchMetadata(config.id, query, userProfile?.omdbKey);
                if (results && results.length > 0) { setSearchResults(results); setSearchActiveKey(key); setSearchModalOpen(true); } 
                else if (config.id === 'movies' && !userProfile?.omdbKey) { window.open(`https://www.google.com/search?q=movie+${encodeURIComponent(query)}`, '_blank'); } 
                else { alert("No results found."); }
            };

            const handleSelectSearchResult = async (item) => {
                setSearchModalOpen(false);
                let meta = item;
                if (config.id === 'movies') { const details = await fetchDetails('movies', item.id, userProfile?.omdbKey); if (details) meta = details; }
                handleAddEntry(searchActiveKey, localInputs[searchActiveKey], meta);
            };

            return (
                <div className="flex-1 flex flex-col overflow-hidden bg-white/30 backdrop-blur-sm">
                    {searchModalOpen && <SearchModal isOpen={searchModalOpen} onClose={() => setSearchModalOpen(false)} results={searchResults} onSelect={handleSelectSearchResult} type={config.id} />}
                    {(config.id === 'movies' || config.id === 'songs') && (
                        <div className="shrink-0 p-4 border-b border-white/50 bg-white/40">
                            <div className="flex items-center justify-between mb-2">
                                <h3 className="text-xs font-bold text-indigo-800 uppercase tracking-wide flex items-center gap-2">
                                    <IconFire className="w-4 h-4 text-orange-500" /> {t.trending}
                                </h3>
                                {!trendingLoading && trending.length > 0 && (
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={refreshTrending}
                                            className="text-xs font-bold text-green-600 hover:text-green-800 px-3 py-1 rounded-lg hover:bg-green-50 transition-all"
                                            title="Refresh to see first batch"
                                        >
                                            ðŸ”„ Refresh
                                        </button>
                                        <button 
                                            onClick={loadMoreTrending}
                                            className="text-xs font-bold text-indigo-600 hover:text-indigo-800 px-3 py-1 rounded-lg hover:bg-indigo-50 transition-all"
                                        >
                                            Load More â†’
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            {trendingLoading ? (
                                <div className="flex flex-col items-center justify-center py-8 gap-3">
                                    <div className="w-full max-w-xs bg-slate-200 rounded-full h-2 overflow-hidden">
                                        <div className="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 animate-pulse-loading rounded-full" style={{width: '60%'}}></div>
                                    </div>
                                    <p className="text-xs text-slate-500 italic">Loading recommendations...</p>
                                </div>
                            ) : trending.length > 0 ? (
                                <div className="overflow-x-auto no-scrollbar">
                                    <div className="flex gap-4 min-w-max justify-center">
                                        {trending.map((item, idx) => (
                                            <div key={idx} className="flex flex-col w-28 group relative">
                                                <div className="w-28 h-40 rounded-xl overflow-hidden shadow-md relative bg-slate-200">
                                                    <a href={item.link} target="_blank" rel="noopener noreferrer" className="block w-full h-full">
                                                        <img src={item.image} alt={item.title} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                                                    </a>
                                                    {addedId === idx ? (
                                                        <div className="absolute inset-0 bg-green-500/90 flex items-center justify-center animate-in backdrop-blur-sm z-10"><span className="text-white font-extrabold text-xs tracking-wider">ADDED!</span></div>
                                                    ) : (
                                                        <button onClick={(e) => { e.stopPropagation(); handleAddTrending(item, idx); }} className="absolute bottom-2 right-2 bg-white text-indigo-600 p-2 rounded-full shadow-lg hover:bg-indigo-600 hover:text-white transition-all transform hover:scale-110 z-10" title="Add to current month"><IconPlus className="w-4 h-4" /></button>
                                                    )}
                                                </div>
                                                <div className="mt-2"><h4 className="text-[10px] font-bold text-slate-800 leading-tight truncate">{item.title}</h4><p className="text-[9px] text-slate-500 truncate">{item.subtitle}</p></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <p className="text-xs text-slate-400 italic text-center py-4">No recommendations available</p>
                            )}
                        </div>
                    )}
                    <div className="flex-1 overflow-auto p-4 md:p-8 touch-pan-y"><div className="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{items.map((item, index) => {
                        const key = isWeekly ? `week-${item}` : index.toString();
                        const label = isWeekly ? `${t.week} ${item} (${getWeekRange(item, year)})` : t.months[index];
                        const entries = Array.isArray(data[key]) ? data[key] : (data[key] ? [data[key]] : []);
                        const isListening = listeningId === key;
                        return (
                            <div key={key} className="bg-white/90 rounded-2xl p-4 shadow-sm border border-white/50 hover:shadow-md transition-shadow relative flex flex-col gap-3 min-h-[160px]">
                                <div className="flex justify-between items-center pb-2 border-b border-slate-100"><h3 className="font-bold text-indigo-600 uppercase tracking-wide text-xs">{label}</h3><span className="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">{entries.length}</span></div>
                                <div className="flex-1 flex flex-col gap-2 overflow-y-auto max-h-[300px]">
                                    {entries.length === 0 && <div className="text-xs text-slate-400 italic text-center py-4">No entries yet</div>}
                                    {entries.map(entry => (
                                        <div key={entry.id || Math.random()} className="relative group animate-in">
                                            {entry.meta ? (
                                                <a href={entry.meta.link} target="_blank" className="flex gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100 hover:bg-indigo-50 transition-colors">
                                                    {entry.meta.image ? <img src={entry.meta.image} className="w-12 h-16 object-cover rounded-lg bg-slate-200" /> : <div className="w-12 h-16 flex items-center justify-center text-2xl bg-slate-200 rounded-lg">ðŸŽ¬</div>}
                                                    <div className="flex-1 min-w-0 flex flex-col justify-center">
                                                        <h4 className="font-bold text-xs text-slate-800 truncate">{entry.meta.title}</h4>
                                                        <p className="text-[10px] text-slate-500 truncate">{entry.meta.subtitle}</p>
                                                        <p className="text-[10px] text-indigo-500 font-medium truncate mt-0.5">{entry.meta.info}</p>
                                                    </div>
                                                </a>
                                            ) : (
                                                <div className="bg-yellow-50 p-3 rounded-xl border border-yellow-100 text-xs text-slate-700 whitespace-pre-wrap">{entry.text || entry}</div>
                                            )}
                                            <button onClick={(e) => { e.stopPropagation(); if(confirm("Remove?")) onUpdateData(key, entries.filter(x => x !== entry)); }} className="absolute -top-2 -right-2 p-1 bg-white text-red-400 rounded-full shadow-md sm:opacity-0 sm:group-hover:opacity-100">
                                                <IconX className="w-3 h-3" />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2 items-center mt-auto pt-2 border-t border-slate-100">
                                    <div className="flex-1 relative">
                                        <input type="text" value={localInputs[key]||''} onChange={(e) => setLocalInputs(p => ({...p,[key]:e.target.value}))} onKeyDown={(e)=>e.key==='Enter'&&handleAddEntry(key,localInputs[key])} placeholder={isListening ? t.listening : t.addEntry} className={`w-full bg-slate-50 rounded-lg pl-3 pr-8 py-2 text-xs border border-slate-200 focus:border-indigo-400 outline-none ${isListening ? 'bg-red-50 border-red-200 placeholder-red-400' : ''}`} />
                                        <button onClick={()=>handleAddEntry(key,localInputs[key])} className={`absolute right-1 top-1/2 -translate-y-1/2 p-1 ${!localInputs[key]?'hidden':''}`}><IconPlus className="w-3.5 h-3.5 text-slate-400 hover:text-indigo-600" /></button>
                                    </div>
                                    <div className="flex gap-1 shrink-0">
                                        {(config.id==='movies'||config.id==='songs')&&<button onClick={()=>handleMagic(key)} className="p-2 rounded-lg bg-indigo-50 text-indigo-500 hover:bg-indigo-100"><IconWand className="w-4 h-4" /></button>}
                                        <button onClick={() => handleSpeech(key)} className={`p-2 rounded-lg transition-all ${isListening ? 'bg-red-100 text-red-500 animate-pulse-mic' : 'bg-slate-100 text-slate-400 hover:bg-indigo-50 hover:text-indigo-500'}`}><IconMic className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            </div>
                        );
                    })}</div></div></div>
            );
        };

        const PixelGridView = ({ config, data, colors, onCellClick, activePaintValue, setActivePaintValue, setEditingColorLevel, year, trackerStatus, t, userProfile, onAutoFill, onMonthClick }) => {
             const getDaysInMonth = (monthIndex) => new Date(year, monthIndex + 1, 0).getDate();
             const today = new Date();
             const [isDragging, setIsDragging] = useState(false);
             const [exporting, setExporting] = useState(false);
             const gridRef = useRef(null);
             
             // Paint value selection handler with logging
             const handlePaintValueSelect = (value) => {
                 console.log('ðŸŽ¨ Paint value selected:', value);
                 setActivePaintValue(value);
             };
             
             // Log current paint value
             useEffect(() => {
                 console.log('ðŸ“ Current active paint value:', activePaintValue);
             }, [activePaintValue]);
             
             // Add global mouseup and touchend listeners to stop dragging
             useEffect(() => {
                 const handleMouseUp = () => setIsDragging(false);
                 const handleTouchEnd = () => setIsDragging(false);
                 document.addEventListener('mouseup', handleMouseUp);
                 document.addEventListener('touchend', handleTouchEnd);
                 return () => {
                     document.removeEventListener('mouseup', handleMouseUp);
                     document.removeEventListener('touchend', handleTouchEnd);
                 };
             }, []);
             
             // Unified click handler for both mouse and touch
             const handleCellInteraction = (monthIndex, day, isFuture) => {
                 if (!isFuture) {
                     console.log('Cell clicked:', monthIndex, day, 'Paint value:', activePaintValue);
                     setIsDragging(true);
                     onCellClick(monthIndex, day);
                 }
             };
             
             const handleCellDrag = (monthIndex, day, isFuture) => {
                 if (isDragging && !isFuture) {
                     console.log('Cell dragged:', monthIndex, day);
                     onCellClick(monthIndex, day);
                 }
             };
             
             const handleSnapshot = async () => {
                 if (!gridRef.current || !window.html2canvas) return;
                 setExporting(true);
                 try {
                     const canvas = await html2canvas(gridRef.current, {
                         backgroundColor: '#ffffff',
                         scale: 2,
                         logging: false,
                         useCORS: true
                     });
                     const link = document.createElement('a');
                     link.download = `${config.id}_${year}_${new Date().getTime()}.png`;
                     link.href = canvas.toDataURL('image/png');
                     link.click();
                 } catch (err) {
                     console.error('Export failed:', err);
                     alert('Failed to export image. Please try again.');
                 }
                 setExporting(false);
             };
             
             return (
                <div className="flex-1 flex flex-col overflow-hidden bg-white/30 backdrop-blur-sm relative">
                    {config.id === 'weather' && <WeatherWidget location={userProfile?.location} t={t} />}
                    <div className="flex-1 flex flex-col md:flex-row overflow-hidden relative">
                         {trackerStatus && <div className={`absolute top-2 left-1/2 -translate-x-1/2 z-20 px-4 py-2 rounded-full shadow-lg text-xs font-bold flex items-center gap-2 animate-in pointer-events-none ${trackerStatus.type === 'success' ? 'bg-green-500 text-white' : 'bg-orange-500 text-white'}`}>{trackerStatus.message}</div>}
                        <div className="md:w-64 md:border-r border-white/40 bg-white/50 p-4 md:overflow-y-auto flex-shrink-0 backdrop-blur-md flex flex-col gap-4">
                            {config.id === 'weather' && <button onClick={onAutoFill} className="w-full py-3 bg-gradient-to-r from-blue-400 to-indigo-500 text-white rounded-xl font-bold text-xs shadow-md flex items-center justify-center gap-2 mb-2"><IconBolt className="w-4 h-4" /> {t.autoFill}</button>}
                            <button 
                                onClick={handleSnapshot} 
                                disabled={exporting}
                                className="w-full py-3 bg-gradient-to-r from-pink-400 to-orange-500 text-white rounded-xl font-bold text-xs shadow-md flex items-center justify-center gap-2 hover:from-pink-500 hover:to-orange-600 transition-all disabled:opacity-50"
                            >
                                <IconDownload className="w-4 h-4" /> {exporting ? (t.exporting || 'Exporting...') : (t.downloadSnapshot || 'ðŸ“¸ Download Snapshot')}
                            </button>
                            <div className="flex-1 min-h-0 flex flex-col"><h3 className="text-xs font-bold text-indigo-900 uppercase tracking-wider mb-3 hidden md:block opacity-70">{t.legend}</h3><div className="flex flex-row md:flex-col gap-3 overflow-x-auto md:overflow-visible pb-2 md:pb-0 no-scrollbar items-center md:items-stretch">{config.levels.map((level) => { const isActive = activePaintValue === level.value; return (<div key={level.value} className={`flex items-center gap-3 p-2 rounded-2xl border cursor-pointer transition-all flex-shrink-0 min-w-[140px] md:min-w-0 select-none ${isActive ? 'bg-white border-indigo-500 ring-2 ring-indigo-200 shadow-lg transform scale-105' : 'bg-white/80 border-transparent hover:bg-white hover:shadow-md'}`} onClick={() => handlePaintValueSelect(level.value)} onPointerDown={(e) => { e.stopPropagation(); handlePaintValueSelect(level.value); }}><div className="w-10 h-10 rounded-xl shadow-inner flex items-center justify-center group relative overflow-hidden border-2 border-white/50" style={{ backgroundColor: colors[level.value]||level.defaultColor }}><button onClick={(e) => { e.stopPropagation(); setEditingColorLevel({ value: level.value, label: level.label }); }} className="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity"><IconSettings className="w-5 h-5 text-white" /></button></div><div className="flex flex-col"><span className={`text-sm font-bold ${isActive ? 'text-indigo-700' : 'text-slate-700'}`}>{level.label}</span></div></div>);})}</div></div>
                        </div>
                        <div className="flex-1 overflow-auto p-2 md:p-8 touch-pan-x touch-pan-y">
                            <div ref={gridRef} className="bg-white/90 backdrop-blur-xl rounded-3xl shadow-lg border border-white/50 p-4 md:p-6 overflow-x-auto min-w-fit mx-auto">
                                <div className="select-none inline-block">
                                    <div className="flex mb-1 gap-0">
                                        <div className="w-8 flex-shrink-0"></div>
                                        {t.months.map((m, i) => (<div key={m} onClick={() => onMonthClick(i)} className="w-8 md:w-10 text-center text-xs font-bold text-slate-400 uppercase tracking-wide cursor-pointer hover:text-indigo-600">{m}</div>))}
                                    </div>
                                    {DAYS.map((day) => (
                                        <div key={day} className="flex items-center gap-0">
                                            <div className="w-8 flex-shrink-0 text-right pr-3 text-xs font-mono font-bold text-slate-300">{day}</div>
                                            {MONTHS.map((_, monthIndex) => {
                                                const isValid = day <= getDaysInMonth(monthIndex);
                                                const isFuture = new Date(year, monthIndex, day) > today;
                                                const val = data[`${monthIndex}-${day}`];
                                                if (!isValid) return <div key={`${monthIndex}-${day}`} className="w-8 md:w-10 h-8 md:h-10 bg-slate-100/30"></div>;
                                                return (
                                                    <div key={`${monthIndex}-${day}`}
                                                         data-cell={`${monthIndex}-${day}`}
                                                         onPointerDown={() => handleCellInteraction(monthIndex, day, isFuture)}
                                                         onPointerEnter={() => handleCellDrag(monthIndex, day, isFuture)}
                                                         onPointerUp={() => setIsDragging(false)}
                                                         className={`w-8 h-8 md:w-10 md:h-10 transition-all duration-200 ${isFuture ? 'bg-slate-50 opacity-40 cursor-not-allowed' : 'cursor-pointer hover:rounded-sm active:scale-95 ' + (val ? 'z-0 hover:z-10 hover:scale-110 hover:shadow-xl' : 'bg-white border-[0.5px] border-slate-100 hover:bg-slate-50')}`} 
                                                         style={{ backgroundColor: (isValid && val ? (colors[val] || config.levels.find(l=>l.value===val)?.defaultColor) : ''), touchAction: 'none', userSelect: 'none' }} 
                                                    />
                                                );
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
             );
        };

        const TrackerController = ({ trackerId, onNavigate, user, t, activeConfig, userProfile, onUpdateProfile }) => {
          const config = activeConfig[trackerId];
          const [year, setYear] = useState(2026); 
          const [data, setData] = useState({});
          const [colors, setColors] = useState({});
          const [activePaintValue, setActivePaintValue] = useState(null); 
          const [editingColorLevel, setEditingColorLevel] = useState(null);
          const [loading, setLoading] = useState(true);
          const [statsMonth, setStatsMonth] = useState(null);
          const [showSettings, setShowSettings] = useState(false);
          const isInitialLoad = useRef(true);
          const saveTimeoutRef = useRef(null);
          const { saveData, subscribeToData, clearData } = useDataPersistence();
          const theme = THEMES[userProfile?.theme || 'playful'];

          // --- Restored Navigation Logic ---
          const currentIndex = TRACKER_ORDER.indexOf(trackerId);
          const prevId = currentIndex > 0 ? TRACKER_ORDER[currentIndex - 1] : null;
          const nextId = currentIndex < TRACKER_ORDER.length - 1 ? TRACKER_ORDER[currentIndex + 1] : null;

          let progress = 0; let trackerStatus = null;
          if (config.type === 'pixel') {
              const filled = Object.keys(data).length;
              progress = Math.min(100, Math.round((filled / 365) * 100));
              const today = new Date();
              if (today.getFullYear() === year) {
                  let missing = 0;
                  for(let d = new Date(year,0,1); d <= today; d.setDate(d.getDate()+1)) { if(!data[`${d.getMonth()}-${d.getDate()}`]) missing++; }
                  trackerStatus = missing > 0 ? { type: 'warning', message: `${t.missing} ${missing}!` } : { type: 'success', message: t.allCaughtUp };
              }
          }

          useEffect(() => {
            if (!user) return;
            setLoading(true);
            isInitialLoad.current = true; // Mark that we're loading initial data
            if (config.type === 'pixel') { const m={}; config.levels.forEach(l => m[l.value]=l.defaultColor); setColors(m); }
            const u1 = subscribeToData(user.uid, 'tracker_data', `${trackerId}_${year}`, (d) => { setData(d?.grid || d?.notes || d || {}); setLoading(false); }); 
            const u2 = config.type === 'pixel' ? subscribeToData(user.uid, 'tracker_prefs', trackerId, (d) => { 
                if(d?.colors) setColors(p => ({...p,...d.colors})); 
                // Only load saved paint value on initial mount
                if(isInitialLoad.current && d?.lastPaintValue !== undefined && d?.lastPaintValue !== null) {
                    console.log('ðŸ“¥ Loading saved paint value:', d.lastPaintValue);
                    setActivePaintValue(d.lastPaintValue);
                    isInitialLoad.current = false;
                }
            }) : () => {};
            return () => { 
                u1(); 
                u2(); 
                isInitialLoad.current = true; // Reset for next mount
            };
          }, [user, trackerId, year, config]); 
          
          // Save activePaintValue when it changes (with debounce to prevent loops)
          useEffect(() => {
              if (user && config.type === 'pixel' && activePaintValue !== null && !isInitialLoad.current) {
                  console.log('ðŸ’¾ Saving paint value:', activePaintValue);
                  // Clear any pending save
                  if (saveTimeoutRef.current) {
                      clearTimeout(saveTimeoutRef.current);
                  }
                  // Debounce the save by 500ms to prevent rapid updates
                  saveTimeoutRef.current = setTimeout(() => {
                      saveData(user.uid, 'tracker_prefs', trackerId, { lastPaintValue: activePaintValue });
                      console.log('âœ… Paint value saved to prefs');
                  }, 500);
              }
              return () => {
                  if (saveTimeoutRef.current) {
                      clearTimeout(saveTimeoutRef.current);
                  }
              };
          }, [activePaintValue, user, trackerId, config.type]); 

          // --- Fixed Auto-Fill Logic ---
          const handleAutoFillWeather = async () => {
              if (trackerId !== 'weather') return;
              if (!confirm(t.autoFillConfirm)) return;
              setLoading(true);
              try {
                  const doFill = async (lat, lon) => {
                      const history = await fetchWeatherHistory(lat, lon, year);
                      if (history) {
                          const merged = { ...data };
                          let changed = false;
                          Object.entries(history).forEach(([k, v]) => { if (!merged[k]) { merged[k] = v; changed = true; } });
                          if (changed) { setData(merged); await saveData(user.uid, 'tracker_data', `${trackerId}_${year}`, { grid: merged }); alert("Weather updated!"); }
                          else { alert("Data already up to date."); }
                      } else { alert("Could not fetch weather history."); }
                      setLoading(false);
                  };
                  if (navigator.geolocation) {
                      navigator.geolocation.getCurrentPosition(
                          (pos) => doFill(pos.coords.latitude, pos.coords.longitude), 
                          () => doFill(51.5074, -0.1278) // Fallback London
                      );
                  } else { doFill(51.5074, -0.1278); }
              } catch (e) { setLoading(false); }
          };

          if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500 font-bold animate-pulse">Loading...</div>;

          return (
            <div className={`min-h-screen flex flex-col font-sans ${theme.bg}`}>
              <TrackerHeader 
                config={config} 
                onBack={() => onNavigate('landing')} 
                userAvatar={userProfile?.avatar} 
                onReset={() => confirm(t.resetPageConfirm) && clearData(user.uid, 'tracker_data', `${trackerId}_${year}`)} 
                progress={progress} 
                year={year} 
                onYearChange={setYear} 
                t={t} 
                onNext={nextId ? () => onNavigate(nextId) : null} 
                onPrev={prevId ? () => onNavigate(prevId) : null}
                onAvatarClick={() => onNavigate('settings')}
                onOpenSettings={() => setShowSettings(true)}
              />
              {config.type === 'pixel' ? (
                 <PixelGridView config={config} data={data} colors={colors} activePaintValue={activePaintValue} setActivePaintValue={setActivePaintValue} setEditingColorLevel={setEditingColorLevel} onCellClick={async (m, d) => { const k=`${m}-${d}`, v=data[k]===activePaintValue?null:activePaintValue; const n={...data}; if(v)n[k]=v;else delete n[k]; setData(n); await saveData(user.uid,'tracker_data',`${trackerId}_${year}`,{grid:n}); }} year={year} trackerStatus={trackerStatus} t={t} userProfile={userProfile} onAutoFill={handleAutoFillWeather} onMonthClick={setStatsMonth} />
              ) : config.type === 'travel_map' ? (
                 <TravelMapView config={config} data={data} t={t} userProfile={userProfile} onUpdateData={async (k, v) => { const n = { ...data, [k]: v }; setData(n); await saveData(user.uid, 'tracker_data', `${trackerId}_${year}`, { notes: n }); }} />
              ) : config.type === 'daily_log' ? (
                 <LocationLogView config={config} data={data} t={t} onUpdateData={async (newData) => { setData(newData); await saveData(user.uid, 'tracker_data', `${trackerId}_${year}`, newData); }} />
              ) : (
                 <NotesView config={config} data={data} onUpdateData={async (k, v) => { const n={...data,[k]:v}; setData(n); await saveData(user.uid,'tracker_data',`${trackerId}_${year}`,{notes:n}); }} year={year} t={t} userProfile={userProfile} />
              )}
              {statsMonth !== null && <MonthlyStatsModal monthIndex={statsMonth} year={year} data={data} config={config} colors={colors} onClose={() => setStatsMonth(null)} t={t} theme={theme} />}
              {editingColorLevel && <ColorEditor isOpen={true} onClose={() => setEditingColorLevel(null)} level={editingColorLevel} currentColor={colors[editingColorLevel.value]} onSave={async (v, c) => { const n={...colors,[v]:c}; setColors(n); await saveData(user.uid,'tracker_prefs',trackerId,{colors:n}); }} />}
              {showSettings && <ProfileModal initialData={userProfile} onComplete={(data) => { onUpdateProfile(data); setShowSettings(false); }} onClose={() => setShowSettings(false)} t={t} activeConfig={activeConfig} />}
            </div>
          );
        };

        const LiveClock = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            const h = time.getHours().toString().padStart(2, '0');
            const m = time.getMinutes().toString().padStart(2, '0');
            const s = time.getSeconds().toString().padStart(2, '0');
            return <span className="font-mono text-sm font-bold">{h}:{m}:{s}</span>;
        };

        const DateDisplay = () => {
            const now = new Date();
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return <span className="text-sm font-medium">{days[now.getDay()]}, {months[now.getMonth()]} {now.getDate()}, {now.getFullYear()}</span>;
        };

        // Year Snapshot Modal - Beautiful visual summary
        // Theme Customization Modal
        const ThemeCustomizationModal = ({ isOpen, onClose, userProfile, onSave, t }) => {
            const [activeTab, setActiveTab] = useState('presets');
            const [backgrounds, setBackgrounds] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedPage, setSelectedPage] = useState('landing');
            const [customBg, setCustomBg] = useState('');
            
            const presetThemes = [
                { id: 'gradient', name: 'Default Gradient', bg: 'bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100', preview: 'linear-gradient(to bottom right, #e0e7ff, #faf5ff, #fce7f3)' },
                { id: 'space', name: 'Space', bg: 'bg-gradient-to-br from-slate-900 via-purple-900 to-violet-900', preview: 'linear-gradient(to bottom right, #0f172a, #581c87, #5b21b6)' },
                { id: 'unicorn', name: 'Unicorn Dreams', bg: 'bg-gradient-to-br from-pink-300 via-purple-300 to-indigo-400', preview: 'linear-gradient(to bottom right, #f9a8d4, #d8b4fe, #818cf8)' },
                { id: 'ocean', name: 'Ocean Breeze', bg: 'bg-gradient-to-br from-cyan-200 via-blue-300 to-indigo-400', preview: 'linear-gradient(to bottom right, #a5f3fc, #93c5fd, #818cf8)' },
                { id: 'sunset', name: 'Sunset Vibes', bg: 'bg-gradient-to-br from-orange-300 via-pink-300 to-purple-400', preview: 'linear-gradient(to bottom right, #fdba74, #f9a8d4, #c084fc)' },
                { id: 'forest', name: 'Forest Green', bg: 'bg-gradient-to-br from-green-200 via-emerald-300 to-teal-400', preview: 'linear-gradient(to bottom right, #bbf7d0, #6ee7b7, #2dd4bf)' },
                { id: 'dark', name: 'Dark Mode', bg: 'bg-gradient-to-br from-gray-900 via-slate-800 to-zinc-900', preview: 'linear-gradient(to bottom right, #111827, #1e293b, #18181b)' },
                { id: 'pastel', name: 'Soft Pastels', bg: 'bg-gradient-to-br from-rose-100 via-pink-100 to-fuchsia-100', preview: 'linear-gradient(to bottom right, #ffe4e6, #fce7f3, #fae8ff)' },
            ];
            
            const pages = [
                { id: 'landing', name: 'Landing Page', icon: 'ðŸ ' },
                { id: 'rateMyDay', name: 'Rate My Day', icon: 'ðŸ˜Š' },
                { id: 'emotions', name: 'Emotions', icon: 'ðŸ’­' },
                { id: 'anxiety', name: 'Anxiety', icon: 'ðŸ§˜' },
                { id: 'weather', name: 'Weather', icon: 'ðŸŒ¤ï¸' },
                { id: 'health', name: 'Health', icon: 'â¤ï¸' },
                { id: 'movies', name: 'Movies', icon: 'ðŸŽ¬' },
                { id: 'songs', name: 'Songs', icon: 'ðŸŽµ' },
                { id: 'weekly_moments', name: 'Weekly Moments', icon: 'ðŸ“' },
            ];
            
            useEffect(() => {
                if (activeTab === 'unsplash' && backgrounds.length === 0) {
                    fetchUnsplashBackgrounds();
                }
            }, [activeTab]);
            
            const fetchUnsplashBackgrounds = async () => {
                setLoading(true);
                try {
                    // Using Unsplash Source API (no API key needed for basic usage)
                    const categories = ['nature', 'gradient', 'space', 'abstract', 'minimal'];
                    const bgList = categories.map((cat, idx) => ({
                        id: `unsplash-${cat}-${idx}`,
                        url: `https://source.unsplash.com/800x600/?${cat},wallpaper`,
                        category: cat
                    }));
                    
                    // Add more variety
                    const additionalBgs = [
                        { id: 'unsplash-ocean', url: 'https://source.unsplash.com/800x600/?ocean,blue', category: 'ocean' },
                        { id: 'unsplash-sunset', url: 'https://source.unsplash.com/800x600/?sunset,sky', category: 'sunset' },
                        { id: 'unsplash-flowers', url: 'https://source.unsplash.com/800x600/?flowers,colorful', category: 'flowers' },
                        { id: 'unsplash-mountains', url: 'https://source.unsplash.com/800x600/?mountains,landscape', category: 'mountains' },
                        { id: 'unsplash-city', url: 'https://source.unsplash.com/800x600/?city,night', category: 'city' },
                    ];
                    
                    setBackgrounds([...bgList, ...additionalBgs]);
                } catch (err) {
                    console.error('Failed to load backgrounds:', err);
                }
                setLoading(false);
            };
            
            const handleSaveTheme = (themeId) => {
                const theme = presetThemes.find(t => t.id === themeId);
                if (theme) {
                    const currentThemes = userProfile?.pageThemes || {};
                    currentThemes[selectedPage] = { type: 'preset', id: themeId, bg: theme.bg };
                    onSave({ ...userProfile, pageThemes: currentThemes });
                }
            };
            
            const handleSaveBackground = (bgUrl) => {
                const currentThemes = userProfile?.pageThemes || {};
                currentThemes[selectedPage] = { type: 'image', url: bgUrl };
                onSave({ ...userProfile, pageThemes: currentThemes });
            };
            
            const handleSaveCustomBg = () => {
                if (customBg) {
                    handleSaveBackground(customBg);
                    setCustomBg('');
                }
            };
            
            if (!isOpen) return null;
            
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[90] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl w-full max-w-5xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col" onClick={(e) => e.stopPropagation()}>
                        <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-6 text-white">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-2xl font-bold">ðŸŽ¨ Customize Your Vibe</h2>
                                <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-xl transition-colors">
                                    <IconX className="w-6 h-6" />
                                </button>
                            </div>
                            
                            {/* Page Selector */}
                            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                {pages.map(page => (
                                    <button
                                        key={page.id}
                                        onClick={() => setSelectedPage(page.id)}
                                        className={`px-4 py-2 rounded-xl font-bold text-sm whitespace-nowrap transition-all ${
                                            selectedPage === page.id 
                                            ? 'bg-white text-purple-600 shadow-lg' 
                                            : 'bg-white/20 hover:bg-white/30'
                                        }`}
                                    >
                                        {page.icon} {page.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* Tabs */}
                        <div className="flex border-b border-slate-200 bg-slate-50">
                            <button
                                onClick={() => setActiveTab('presets')}
                                className={`flex-1 px-6 py-3 font-bold text-sm ${activeTab === 'presets' ? 'bg-white text-purple-600 border-b-2 border-purple-600' : 'text-slate-600 hover:text-purple-600'}`}
                            >
                                ðŸŽ¨ Preset Themes
                            </button>
                            <button
                                onClick={() => setActiveTab('unsplash')}
                                className={`flex-1 px-6 py-3 font-bold text-sm ${activeTab === 'unsplash' ? 'bg-white text-purple-600 border-b-2 border-purple-600' : 'text-slate-600 hover:text-purple-600'}`}
                            >
                                ðŸ–¼ï¸ Photo Backgrounds
                            </button>
                            <button
                                onClick={() => setActiveTab('custom')}
                                className={`flex-1 px-6 py-3 font-bold text-sm ${activeTab === 'custom' ? 'bg-white text-purple-600 border-b-2 border-purple-600' : 'text-slate-600 hover:text-purple-600'}`}
                            >
                                ðŸ”— Custom URL
                            </button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-6">
                            {activeTab === 'presets' && (
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {presetThemes.map(theme => (
                                        <div
                                            key={theme.id}
                                            onClick={() => handleSaveTheme(theme.id)}
                                            className="cursor-pointer group"
                                        >
                                            <div 
                                                className="h-32 rounded-2xl mb-2 border-4 border-transparent group-hover:border-purple-500 transition-all shadow-lg"
                                                style={{ background: theme.preview }}
                                            />
                                            <p className="text-sm font-bold text-slate-700 text-center">{theme.name}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {activeTab === 'unsplash' && (
                                <div>
                                    {loading ? (
                                        <div className="text-center py-12 text-slate-500">Loading beautiful backgrounds...</div>
                                    ) : (
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            {backgrounds.map(bg => (
                                                <div
                                                    key={bg.id}
                                                    onClick={() => handleSaveBackground(bg.url)}
                                                    className="cursor-pointer group relative"
                                                >
                                                    <div className="aspect-video rounded-2xl overflow-hidden border-4 border-transparent group-hover:border-purple-500 transition-all shadow-lg">
                                                        <img src={bg.url} alt={bg.category} className="w-full h-full object-cover" />
                                                    </div>
                                                    <p className="text-xs font-bold text-slate-600 text-center mt-2 capitalize">{bg.category}</p>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    <p className="text-xs text-slate-500 text-center mt-4">Photos from Unsplash</p>
                                </div>
                            )}
                            
                            {activeTab === 'custom' && (
                                <div className="max-w-2xl mx-auto">
                                    <div className="bg-blue-50 border border-blue-200 rounded-2xl p-6 mb-6">
                                        <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                            ðŸ’¡ How to use custom backgrounds
                                        </h3>
                                        <ul className="text-sm text-slate-600 space-y-1">
                                            <li>â€¢ Upload your image to Imgur or any image host</li>
                                            <li>â€¢ Copy the direct image URL (ends with .jpg, .png, etc.)</li>
                                            <li>â€¢ Paste it below and click Save</li>
                                        </ul>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <input
                                            type="text"
                                            value={customBg}
                                            onChange={(e) => setCustomBg(e.target.value)}
                                            placeholder="https://i.imgur.com/yourimage.jpg"
                                            className="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:border-purple-500 outline-none"
                                        />
                                        <button
                                            onClick={handleSaveCustomBg}
                                            disabled={!customBg}
                                            className="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed hover:from-purple-600 hover:to-pink-600 transition-all"
                                        >
                                            Save Custom Background
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const YearSnapshotModal = ({ isOpen, onClose, userProfile, year, stats, counts, t }) => {
            const snapshotRef = useRef(null);
            const [exporting, setExporting] = useState(false);
            
            if (!isOpen) return null;
            
            const handleExport = async () => {
                if (!snapshotRef.current || !window.html2canvas) return;
                setExporting(true);
                try {
                    const canvas = await html2canvas(snapshotRef.current, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        logging: false,
                        useCORS: true
                    });
                    const link = document.createElement('a');
                    link.download = `VibeVault_Year_${year}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) {
                    console.error('Export failed:', err);
                }
                setExporting(false);
            };
            
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[90] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl" onClick={(e) => e.stopPropagation()}>
                        <div className="sticky top-0 bg-white border-b border-slate-100 p-4 flex items-center justify-between rounded-t-3xl z-10">
                            <h2 className="text-xl font-bold text-slate-800">âœ¨ {userProfile?.name || t.yearSnapshot || 'My'} {year} {t.yearInReview?.replace('âœ¨ ','').replace('My ','') || 'Year in Review'}</h2>
                            <div className="flex gap-2">
                                <button 
                                    onClick={handleExport}
                                    disabled={exporting}
                                    className="px-4 py-2 bg-gradient-to-r from-pink-500 to-orange-500 text-white rounded-xl font-bold text-sm flex items-center gap-2 hover:from-pink-600 hover:to-orange-600 disabled:opacity-50"
                                >
                                    <IconDownload className="w-4 h-4" /> {exporting ? (t.exporting || 'Exporting...') : (t.downloadSnapshot?.split(' ')[1] || 'Download')}
                                </button>
                                <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-xl">
                                    <IconX className="w-5 h-5 text-slate-400" />
                                </button>
                            </div>
                        </div>
                        
                        <div ref={snapshotRef} className="p-8 bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
                            {/* Header */}
                            <div className="text-center mb-8">
                                <h1 className="text-5xl font-extrabold bg-gradient-to-r from-purple-600 via-pink-500 to-orange-500 bg-clip-text text-transparent mb-2">
                                    {userProfile?.name || 'My'}'s {year}
                                </h1>
                                <p className="text-lg text-slate-600 font-medium">A Year of Vibes âœ¨</p>
                            </div>
                            
                            {/* Stats Grid */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div className="bg-white rounded-2xl p-4 shadow-md border-2 border-purple-200">
                                    <div className="text-3xl mb-2">ðŸŽ¬</div>
                                    <div className="text-2xl font-bold text-purple-600">{counts?.movies || 0}</div>
                                    <div className="text-xs text-slate-600 font-medium">{t.moviesWatched || 'Movies Watched'}</div>
                                </div>
                                <div className="bg-white rounded-2xl p-4 shadow-md border-2 border-blue-200">
                                    <div className="text-3xl mb-2">ðŸŽµ</div>
                                    <div className="text-2xl font-bold text-blue-600">{counts?.songs || 0}</div>
                                    <div className="text-xs text-slate-600 font-medium">{t.songsLoved || 'Songs Loved'}</div>
                                </div>
                                <div className="bg-white rounded-2xl p-4 shadow-md border-2 border-green-200">
                                    <div className="text-3xl mb-2">âœˆï¸</div>
                                    <div className="text-2xl font-bold text-green-600">{counts?.travel || 0}</div>
                                    <div className="text-xs text-slate-600 font-medium">{t.tripsTaken || 'Trips Taken'}</div>
                                </div>
                                <div className="bg-white rounded-2xl p-4 shadow-md border-2 border-orange-200">
                                    <div className="text-3xl mb-2">ðŸ“</div>
                                    <div className="text-2xl font-bold text-orange-600">{counts?.locations || 0}</div>
                                    <div className="text-xs text-slate-600 font-medium">{t.placesVisited || 'Places Visited'}</div>
                                </div>
                            </div>
                            
                            {/* Mood Overview */}
                            {stats?.moodStats && (
                                <div className="bg-white rounded-2xl p-6 shadow-md mb-6 border-2 border-pink-200">
                                    <h3 className="text-lg font-bold text-pink-600 mb-4 flex items-center gap-2">
                                        ðŸ˜Š My Year in Moods
                                    </h3>
                                    <div className="grid grid-cols-5 gap-2">
                                        {[1,2,3,4,5].map(mood => {
                                            const count = stats.moodStats[mood] || 0;
                                            const percentage = stats.totalDays ? Math.round((count / stats.totalDays) * 100) : 0;
                                            return (
                                                <div key={mood} className="text-center">
                                                    <div className="text-2xl mb-1">{['ðŸ˜¢','ðŸ˜•','ðŸ˜','ðŸ™‚','ðŸ˜„'][mood-1]}</div>
                                                    <div className="text-lg font-bold text-slate-700">{count}</div>
                                                    <div className="text-xs text-slate-500">{percentage}%</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                            
                            {/* Tracker Stats */}
                            <div className="bg-white rounded-2xl p-6 shadow-md mb-6 border-2 border-indigo-200">
                                <h3 className="text-lg font-bold text-indigo-600 mb-4 flex items-center gap-2">
                                    ðŸ“Š My Tracking Journey
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {stats?.emotionStats && (
                                        <div className="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-4 border border-yellow-200">
                                            <div className="text-2xl mb-2">ðŸ˜Š</div>
                                            <div className="font-bold text-slate-800 mb-1">Emotions Tracked</div>
                                            <div className="text-sm text-slate-600">
                                                {stats.totalEmotionDays || 0} days logged
                                                {stats.topEmotion && <span className="block text-xs mt-1">Most felt: {stats.topEmotion}</span>}
                                            </div>
                                        </div>
                                    )}
                                    {stats?.anxietyStats && (
                                        <div className="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-4 border border-blue-200">
                                            <div className="text-2xl mb-2">ðŸ§˜</div>
                                            <div className="font-bold text-slate-800 mb-1">Anxiety Tracked</div>
                                            <div className="text-sm text-slate-600">
                                                {stats.totalAnxietyDays || 0} days logged
                                                {stats.avgAnxiety && <span className="block text-xs mt-1">Avg level: {stats.avgAnxiety}/10</span>}
                                            </div>
                                        </div>
                                    )}
                                    {stats?.weatherStats && (
                                        <div className="bg-gradient-to-br from-sky-50 to-blue-50 rounded-xl p-4 border border-sky-200">
                                            <div className="text-2xl mb-2">ðŸŒ¤ï¸</div>
                                            <div className="font-bold text-slate-800 mb-1">Weather Tracked</div>
                                            <div className="text-sm text-slate-600">
                                                {stats.totalWeatherDays || 0} days logged
                                                {stats.sunnyDays && <span className="block text-xs mt-1">â˜€ï¸ Sunny days: {stats.sunnyDays}</span>}
                                            </div>
                                        </div>
                                    )}
                                    {stats?.healthStats && (
                                        <div className="bg-gradient-to-br from-red-50 to-pink-50 rounded-xl p-4 border border-red-200">
                                            <div className="text-2xl mb-2">â¤ï¸</div>
                                            <div className="font-bold text-slate-800 mb-1">Health Tracked</div>
                                            <div className="text-sm text-slate-600">
                                                {stats.totalHealthDays || 0} days logged
                                                {stats.exerciseDays && <span className="block text-xs mt-1">ðŸ’ª Exercise: {stats.exerciseDays} days</span>}
                                            </div>
                                        </div>
                                    )}
                                    {stats?.totalNotes && (
                                        <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-200">
                                            <div className="text-2xl mb-2">ðŸ“</div>
                                            <div className="font-bold text-slate-800 mb-1">Journal Entries</div>
                                            <div className="text-sm text-slate-600">
                                                {stats.totalNotes} notes written
                                                {stats.longestNote && <span className="block text-xs mt-1">Longest: {stats.longestNote} words</span>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Top Movies */}
                            {stats?.topMovies && stats.topMovies.length > 0 && (
                                <div className="bg-white rounded-2xl p-6 shadow-md mb-6 border-2 border-purple-200">
                                    <h3 className="text-lg font-bold text-purple-600 mb-4 flex items-center gap-2">
                                        ðŸŽ¬ Favorite Movies
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {stats.topMovies.slice(0, 6).map((movie, idx) => (
                                            <div key={idx} className="bg-purple-50 rounded-xl p-3 border border-purple-100">
                                                <div className="text-sm font-bold text-slate-800 truncate">{movie.title}</div>
                                                <div className="text-xs text-slate-500 truncate">{movie.subtitle}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Top Songs */}
                            {stats?.topSongs && stats.topSongs.length > 0 && (
                                <div className="bg-white rounded-2xl p-6 shadow-md mb-6 border-2 border-blue-200">
                                    <h3 className="text-lg font-bold text-blue-600 mb-4 flex items-center gap-2">
                                        ðŸŽµ Top Songs
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {stats.topSongs.slice(0, 6).map((song, idx) => (
                                            <div key={idx} className="bg-blue-50 rounded-xl p-3 border border-blue-100">
                                                <div className="text-sm font-bold text-slate-800 truncate">{song.title}</div>
                                                <div className="text-xs text-slate-500 truncate">{song.subtitle}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Cities Visited */}
                            {stats?.cities && stats.cities.length > 0 && (
                                <div className="bg-white rounded-2xl p-6 shadow-md mb-6 border-2 border-green-200">
                                    <h3 className="text-lg font-bold text-green-600 mb-4 flex items-center gap-2">
                                        ðŸŒ Places I've Been
                                    </h3>
                                    <div className="flex flex-wrap gap-2">
                                        {stats.cities.slice(0, 15).map((city, idx) => (
                                            <div key={idx} className="bg-green-50 px-3 py-2 rounded-full border border-green-100">
                                                <span className="text-sm font-medium text-slate-700">{city}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Footer */}
                            <div className="text-center mt-8 pt-6 border-t border-slate-200">
                                <p className="text-sm text-slate-500 font-medium">Created with VibeVault âœ¨</p>
                                <p className="text-xs text-slate-400 mt-1">{new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Release Notes Modal - Complete version history
        const ReleaseNotesModal = ({ isOpen, onClose, t }) => {
            const [activeVersion, setActiveVersion] = useState('v4');
            
            if (!isOpen) return null;
            
            const releases = {
                v4: {
                    version: "4.0.0",
                    date: "January 2026",
                    title: "ðŸŽ¨ Personalization & Privacy Update",
                    features: [
                        { icon: "ðŸŽ¨", title: "Custom Themes & Wallpapers", desc: "8 preset themes, 10 Unsplash photos, custom URLs, per-page customization" },
                        { icon: "ðŸ’­", title: "Daily Writing Prompts", desc: "20 surprise prompts that change daily to beat writer's block" },
                        { icon: "ðŸ”’", title: "Privacy Lock with PIN", desc: "4-digit PIN protection to keep your diary private from siblings" },
                        { icon: "ðŸ“¸", title: "Snapshot Export", desc: "Download beautiful PNGs of your trackers for social sharing" },
                        { icon: "âœ¨", title: "Year in Review", desc: "Gorgeous annual summary with stats, moods, movies, songs, and cities" },
                        { icon: "ðŸ“Š", title: "Enhanced Trackers", desc: "Drag-to-paint, remember last selection, 10-day weather forecast" },
                    ]
                },
                v3: {
                    version: "3.0.0",
                    date: "December 2025",
                    title: "ðŸ¤– AI-Powered Features",
                    features: [
                        { icon: "âš¡", title: "6-Step Daily Check-in", desc: "Mood, emotions, anxiety, weather, health, and quick notes in one wizard" },
                        { icon: "ðŸŽ™ï¸", title: "Voice Dictation", desc: "Hands-free journaling with continuous voice input and auto-stop" },
                        { icon: "ðŸ’šâ¤ï¸", title: "Sentiment Highlighting", desc: "Real-time word highlighting - green for positive, red for negative" },
                        { icon: "ðŸ§ ", title: "Vibe Lab AI", desc: "AI-powered insights and analysis of your year's data" },
                        { icon: "ðŸŽ¬ðŸŽµ", title: "Smart Recommendations", desc: "Trending movies and songs with beautiful cards and load more" },
                        { icon: "ðŸ“…", title: "Monday-Aligned Weeks", desc: "Week 1 = Jan 1 to first Saturday, then Monday-Sunday blocks" },
                    ]
                },
                v2: {
                    version: "2.0.0",
                    date: "November 2025",
                    title: "ðŸ“Š Advanced Tracking",
                    features: [
                        { icon: "ðŸ§˜", title: "Anxiety Tracker", desc: "10-level anxiety tracking integrated into daily check-in" },
                        { icon: "ðŸŒ¤ï¸", title: "Weather Factors", desc: "Track how weather affects your mood with auto-detect location" },
                        { icon: "â¤ï¸", title: "Health Tracker", desc: "Monitor exercise, sleep, and wellness factors" },
                        { icon: "ðŸ—ºï¸", title: "Travel & Locations", desc: "Log cities visited and places you've been" },
                        { icon: "ðŸ“", title: "Weekly Best Moments", desc: "Capture highlights and memorable moments each week" },
                        { icon: "ðŸŽ¨", title: "Custom Color Picker", desc: "Personalize colors for every mood and emotion level" },
                    ]
                },
                v1: {
                    version: "1.0.0",
                    date: "October 2025",
                    title: "ðŸš€ Foundation Release",
                    features: [
                        { icon: "ðŸ˜Š", title: "Rate My Day", desc: "5-level mood tracking in a beautiful year-long pixel grid" },
                        { icon: "ðŸ’­", title: "Emotions Tracker", desc: "Track 8 core emotions across the entire year" },
                        { icon: "ðŸŽ¬", title: "Movies of the Month", desc: "Log and remember every movie you watch with OMDB integration" },
                        { icon: "ðŸŽµ", title: "Songs of the Month", desc: "Track your favorite songs with Spotify/Apple Music links" },
                        { icon: "ðŸ‘¤", title: "Profile System", desc: "Set up name, age, location, and preferences" },
                        { icon: "ðŸŒ", title: "Multi-language", desc: "Support for English, Polish, and Spanish" },
                    ]
                }
            };
            
            const versionList = [
                { id: 'v4', label: 'V4.0.0', color: 'from-purple-500 to-pink-500' },
                { id: 'v3', label: 'V3.0.0', color: 'from-blue-500 to-indigo-500' },
                { id: 'v2', label: 'V2.0.0', color: 'from-green-500 to-emerald-500' },
                { id: 'v1', label: 'V1.0.0', color: 'from-orange-500 to-red-500' },
            ];
            
            const currentRelease = releases[activeVersion];
            
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[90] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col" onClick={(e) => e.stopPropagation()}>
                        <div className={`bg-gradient-to-r ${versionList.find(v => v.id === activeVersion).color} p-6 text-white`}>
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-2xl font-bold">ðŸ“‹ Release Notes</h2>
                                <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-xl transition-colors">
                                    <IconX className="w-6 h-6" />
                                </button>
                            </div>
                            <p className="text-white/90 text-sm">Discover all the amazing features we've built!</p>
                        </div>
                        
                        {/* Version Tabs */}
                        <div className="flex border-b border-slate-200 bg-slate-50 overflow-x-auto">
                            {versionList.map(v => (
                                <button
                                    key={v.id}
                                    onClick={() => setActiveVersion(v.id)}
                                    className={`px-6 py-3 font-bold text-sm whitespace-nowrap transition-all ${
                                        activeVersion === v.id
                                            ? `bg-gradient-to-r ${v.color} text-white`
                                            : 'text-slate-600 hover:text-slate-900 hover:bg-slate-100'
                                    }`}
                                >
                                    {v.label}
                                </button>
                            ))}
                        </div>
                        
                        {/* Release Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="mb-6">
                                <div className="flex items-center gap-3 mb-2">
                                    <h3 className="text-2xl font-bold text-slate-800">{currentRelease.title}</h3>
                                </div>
                                <div className="flex items-center gap-4 text-sm text-slate-500">
                                    <span className="font-bold">Version {currentRelease.version}</span>
                                    <span>â€¢</span>
                                    <span>{currentRelease.date}</span>
                                </div>
                            </div>
                            
                            <div className="space-y-4">
                                {currentRelease.features.map((feature, idx) => (
                                    <div key={idx} className="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl p-4 border border-slate-200 hover:shadow-md transition-shadow">
                                        <div className="flex items-start gap-3">
                                            <div className="text-3xl flex-shrink-0">{feature.icon}</div>
                                            <div className="flex-1">
                                                <h4 className="font-bold text-slate-800 mb-1">{feature.title}</h4>
                                                <p className="text-sm text-slate-600">{feature.desc}</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="p-4 bg-slate-50 border-t border-slate-200 text-center">
                            <p className="text-xs text-slate-500">
                                Built with ðŸ’œ by Jiya â€¢ VibeVault V4.0.0
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const LandingPage = ({ onNavigate, userProfile, onUpdateProfile, onResetAll, t, dailyStatus, activeConfig, counts, stats, onExport, onImport, theme, streak, onSaveWizard }) => {
          const [showSettings, setShowSettings] = useState(false);
          const [showHelp, setShowHelp] = useState(false);
          const [showDataMgmt, setShowDataMgmt] = useState(false);
          const [showLab, setShowLab] = useState(false);
          const [showWizard, setShowWizard] = useState(false);
          const [showYearSnapshot, setShowYearSnapshot] = useState(false);
          const [showThemeCustomization, setShowThemeCustomization] = useState(false);
          const [showReleaseNotes, setShowReleaseNotes] = useState(false);
          const [deferredPrompt, setDeferredPrompt] = useState(null);

          useEffect(() => {
              const handleBeforeInstallPrompt = (e) => {
                  e.preventDefault();
                  setDeferredPrompt(e);
              };
              window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
              return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
          }, []);

          const handleInstallClick = async () => {
              if (!deferredPrompt) return;
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              if (outcome === 'accepted') {
                  setDeferredPrompt(null);
              }
          };

          const moodColors = useMemo(() => { const m={}; activeConfig.rateMyDay.levels.forEach(l => m[l.value] = l.defaultColor); return m; }, [activeConfig]);
          const emotionColors = useMemo(() => { const m={}; activeConfig.emotions.levels.forEach(l => m[l.value] = l.defaultColor); return m; }, [activeConfig]);
          
          const getPageTheme = () => {
              const pageTheme = userProfile?.pageThemes?.landing;
              if (!pageTheme) return theme.bg;
              if (pageTheme.type === 'preset') return pageTheme.bg;
              if (pageTheme.type === 'image') return '';
          };
          
          const getPageStyle = () => {
              const pageTheme = userProfile?.pageThemes?.landing;
              if (pageTheme?.type === 'image') {
                  return {
                      backgroundImage: `url(${pageTheme.url})`,
                      backgroundSize: 'cover',
                      backgroundPosition: 'center',
                      backgroundAttachment: 'fixed'
                  };
              }
              return {};
          };
          
          return (
            <div className={`min-h-screen p-6 flex flex-col items-center relative ${getPageTheme()} ${theme.text} transition-colors duration-500`} style={getPageStyle()}>
              {userProfile && (
                  <div className="absolute top-6 right-6 animate-in z-20 flex gap-4">
                      <div className="hidden sm:flex items-center gap-1 bg-white/20 backdrop-blur-md border border-white/40 px-3 py-1 rounded-full text-xs font-bold shadow-sm" title="Current Streak"><span>ðŸ”¥</span> <span>{streak} {t.streak}</span></div>
                      <div className="cursor-pointer group hover:scale-110 transition-transform" onClick={() => setShowThemeCustomization(true)} title="Customize Theme"><div className="w-12 h-12 rounded-full bg-white/50 flex items-center justify-center border-2 border-white shadow-md"><span className="text-2xl">ðŸŽ¨</span></div></div>
                      <div className="cursor-pointer group hover:scale-110 transition-transform" onClick={() => setShowHelp(true)}><div className="w-12 h-12 rounded-full bg-white/50 flex items-center justify-center border-2 border-white shadow-md"><IconHelp className={`w-6 h-6 ${theme.accent}`} /></div></div>
                      <div className="cursor-pointer group hover:scale-110 transition-transform" onClick={() => setShowSettings(true)}>{userProfile.avatar ? <img src={userProfile.avatar} className="w-12 h-12 rounded-full border-2 border-white shadow-md object-cover" /> : <div className="w-12 h-12 rounded-full bg-white/50 flex items-center justify-center border-2 border-white shadow-md"><IconUser className={`w-6 h-6 ${theme.accent}`} /></div>}</div>
                  </div>
              )}
              {showHelp && <HelpModal onClose={() => setShowHelp(false)} t={t} />}
              {showDataMgmt && <DataModal onClose={() => setShowDataMgmt(false)} t={t} onExport={onExport} onImport={onImport} />}
              {showLab && <VibeLabModal isOpen={showLab} onClose={() => setShowLab(false)} t={t} stats={stats} theme={theme} />}
              {showWizard && <WizardModal isOpen={showWizard} onClose={() => setShowWizard(false)} t={t} activeConfig={activeConfig} onSave={onSaveWizard} />}
              {showYearSnapshot && <YearSnapshotModal isOpen={showYearSnapshot} onClose={() => setShowYearSnapshot(false)} userProfile={userProfile} year={2026} stats={stats} counts={counts} t={t} />}
              {showThemeCustomization && <ThemeCustomizationModal isOpen={showThemeCustomization} onClose={() => setShowThemeCustomization(false)} userProfile={userProfile} onSave={onUpdateProfile} t={t} />}
              {showReleaseNotes && <ReleaseNotesModal isOpen={showReleaseNotes} onClose={() => setShowReleaseNotes(false)} t={t} />}
              {(!userProfile || showSettings) && <ProfileModal initialData={userProfile} onComplete={(data) => { onUpdateProfile(data); setShowSettings(false); }} onClose={userProfile ? () => setShowSettings(false) : null} t={t} activeConfig={activeConfig} />}

              <div className="w-full max-w-2xl flex-1 flex flex-col">
                  <header className="mb-8 text-center flex flex-col items-center pt-8">
                    {/* Date and Time on same line, smaller */}
                    <div className="mb-6 bg-white/10 backdrop-blur-md rounded-full px-6 py-2 shadow-lg flex items-center gap-3 text-white/90 animate-in">
                        <DateDisplay />
                        <span className="text-white/50">â€¢</span>
                        <LiveClock />
                    </div>
                    
                    <div className="mb-6 group animate-pop cursor-pointer">
                        <div className="w-28 h-28 bg-white/90 backdrop-blur-md rounded-3xl shadow-2xl flex items-center justify-center border-4 border-white overflow-hidden mx-auto transform transition-transform hover:rotate-3 hover:scale-110 duration-300 relative"><JiyaZeeLogo className="w-full h-full" /></div>
                    </div>
                    <h1 className="text-5xl font-extrabold mb-2 tracking-tight drop-shadow-sm">VibeVault</h1>
                    {userProfile?.name ? (<div className="opacity-90 drop-shadow-sm mt-2 animate-slide-up"><p className="text-xl font-bold">{t.hello}, {userProfile.name}! ðŸ‘‹</p></div>) : (<p className="opacity-90 text-lg font-medium">Your year in pixels. Track your vibe! âœ¨</p>)}
                    
                    {/* NEW AI BUTTONS */}
                    {userProfile && (
                        <div className="flex flex-col gap-3 mt-6 w-full max-w-2xl">
                            <div className="flex flex-col sm:flex-row gap-3 w-full">
                                <button onClick={() => setShowWizard(true)} className="flex-1 px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full font-extrabold text-white shadow-xl flex items-center justify-center gap-2 hover:scale-105 transition-all animate-slide-up ring-4 ring-indigo-200/50 text-sm sm:text-base">
                                    <IconBolt className="w-5 h-5 flex-shrink-0" /> Daily Check-In âš¡
                                </button>
                                <button onClick={() => setShowLab(true)} className="flex-1 px-4 py-3 bg-white/20 backdrop-blur border border-white/50 rounded-full font-bold text-white shadow-lg flex items-center justify-center gap-2 hover:bg-white/30 transition-all animate-slide-up text-sm sm:text-base">
                                    <IconFlask className="w-5 h-5 flex-shrink-0" /> Vibe Lab AI
                                </button>
                            </div>
                            <button 
                                onClick={() => setShowYearSnapshot(true)}
                                className="w-full px-4 py-3 bg-gradient-to-r from-pink-500 via-purple-500 to-orange-500 rounded-full font-extrabold text-white shadow-xl flex items-center justify-center gap-2 hover:scale-105 transition-all animate-slide-up text-sm sm:text-base"
                            >
                                <span className="text-lg">âœ¨</span> {t.yearInReview || "My Year in Review"}
                            </button>
                        </div>
                    )}
                  </header>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-5 w-full mb-8">
                    {Object.values(activeConfig)
                      .filter(tracker => !userProfile?.enabledTrackers || userProfile.enabledTrackers.includes(tracker.id))
                      .map((tracker, idx) => {
                        let icon = <IconCalendar className="w-6 h-6" />;
                        if(tracker.id === 'emotions') icon = <IconSmile className="w-6 h-6" />; if(tracker.id === 'anxiety') icon = <IconActivity className="w-6 h-6" />; if(tracker.id === 'weather') icon = <IconCloudRain className="w-6 h-6" />; if(tracker.id === 'health') icon = <IconHeart className="w-6 h-6" />; if(tracker.id === 'movies') icon = <IconFilm className="w-6 h-6" />; if(tracker.id === 'songs') icon = <IconMusic className="w-6 h-6" />; if(tracker.id === 'weekly_moments') icon = <IconStar className="w-6 h-6" />; 
                        if(tracker.id === 'travel') icon = <IconGlobe className="w-6 h-6" />; if(tracker.id === 'locations') icon = <IconMap className="w-6 h-6" />;
                        const count = counts?.[tracker.id] || 0;
                        return (
                          <button key={tracker.id} onClick={() => onNavigate(tracker.id)} style={{ animationDelay: `${idx * 100}ms` }} className={`relative p-6 rounded-3xl text-left transition-all duration-300 group border animate-in ${theme.card} hover:scale-105 hover:shadow-xl hover:rotate-1`}>
                            <div className="p-4 rounded-2xl w-fit mb-4 shadow-sm transition-transform group-hover:scale-110 duration-300 bg-gradient-to-br from-indigo-100 to-purple-100 text-indigo-600 relative">{icon}
                                {(tracker.id === 'movies' || tracker.id === 'songs' || tracker.id === 'travel' || tracker.id === 'locations') && count > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-md animate-in">{count}</span>}
                            </div>
                            <h2 className="text-xl font-bold mb-1">{t.trackers[tracker.id].title}</h2>
                            <p className="text-sm opacity-70 font-medium leading-snug">{t.trackers[tracker.id].desc}</p>
                          </button>
                        );
                    })}
                  </div>
                  {/* ... rest of dashboard ... */}
                  {userProfile && stats && (
                      <div className={`${theme.card} rounded-2xl p-6 shadow-lg mb-6 animate-slide-up`}>
                          <h3 className={`font-bold ${theme.accent} mb-3 flex items-center gap-2`}><IconActivity className="w-5 h-5" /> Yearly Insights</h3>
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-8">
                              <div><h4 className="text-[10px] font-bold text-slate-500 uppercase mb-2">Mood Distribution</h4><RichInsightsChart data={stats.rateMyDay} colors={moodColors} /></div>
                              <div><h4 className="text-[10px] font-bold text-slate-500 uppercase mb-2">Emotion Breakdown</h4><RichInsightsChart data={stats.emotions} colors={emotionColors} /></div>
                          </div>
                          <div className="mt-4 pt-4 border-t border-slate-200 grid grid-cols-2 gap-4">
                                <div className="text-center">
                                    <span className="block text-2xl font-extrabold text-indigo-500">{counts.travel || 0}</span>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase">Cities Visited</span>
                                </div>
                                <div className="text-center">
                                    <span className="block text-2xl font-extrabold text-purple-500">{counts.locations || 0}</span>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase">Locations Logged</span>
                                </div>
                          </div>
                      </div>
                  )}
                  {userProfile && <BadgePanel streak={streak} counts={counts} theme={theme} />}
                  {userProfile && dailyStatus && (
                      <div className={`${theme.card} rounded-2xl p-6 shadow-lg mb-8 animate-slide-up mt-6`}>
                          <h3 className={`font-bold ${theme.accent} mb-3 flex items-center gap-2`}><IconActivity className="w-5 h-5" /> {t.dailyStatus}</h3>
                          {dailyStatus.complete ? <div className="p-4 bg-green-100 rounded-xl text-green-700 font-bold text-center border border-green-200">{t.allCaughtUp}</div> : (
                              <div><p className="text-sm text-slate-600 mb-2 font-medium">{t.missing}</p><div className="flex flex-wrap gap-2">{dailyStatus.missing.map(id => (<button key={id} onClick={() => onNavigate(id)} className="text-xs font-bold text-orange-600 bg-orange-100 px-3 py-1 rounded-full border border-orange-200 hover:bg-orange-200">{t.trackers[id].title}</button>))}</div></div>
                          )}
                      </div>
                  )}
              </div>
              <footer className="mt-4 w-full flex flex-col items-center gap-2 animate-in pb-20">
                  <div className="bg-white/20 backdrop-blur-md border border-white/30 px-6 py-2 rounded-full shadow-lg"><p className="text-white font-bold text-sm tracking-wide drop-shadow-md">âœ¨ Created by Jiya âœ¨</p></div>
                  <div className="flex flex-wrap gap-2 justify-center">
                     {deferredPrompt && (
                        <button onClick={handleInstallClick} className="flex items-center gap-2 px-3 py-1.5 bg-green-100/50 hover:bg-green-100 text-green-700 rounded-full text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm border border-green-200/50 transition-all"><IconDownload className="w-3 h-3" /> {t.installApp}</button>
                     )}
                     {!deferredPrompt && (
                        <div className="text-center px-4 py-2 bg-blue-100/50 rounded-lg backdrop-blur-sm border border-blue-200/50">
                           <p className="text-[9px] text-blue-700 font-medium">
                              ðŸ“± <strong>Android:</strong> Tap â‹® menu â†’ "Add to Home screen"<br/>
                              ðŸŽ <strong>iOS:</strong> Tap <span className="inline-block">âŽ™</span> share â†’ "Add to Home Screen"
                           </p>
                        </div>
                     )}
                     <button onClick={() => setShowDataMgmt(true)} className="flex items-center gap-2 px-3 py-1.5 bg-blue-100/50 hover:bg-blue-100 text-blue-700 rounded-full text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm border border-blue-200/50 transition-all"><IconDownload className="w-3 h-3" /> Data</button>
                     <button onClick={() => setShowReleaseNotes(true)} className="flex items-center gap-2 px-3 py-1.5 bg-purple-100/50 hover:bg-purple-100 text-purple-700 rounded-full text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm border border-purple-200/50 transition-all cursor-pointer">
                        ðŸ“‹ V4.0.0
                     </button>
                     <button onClick={onResetAll} className="flex items-center gap-2 px-3 py-1.5 bg-red-100/50 hover:bg-red-100 text-red-600 rounded-full text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm border border-red-200/50 transition-all"><IconTrash className="w-3 h-3" /> {t.resetApp}</button>
                  </div>
              </footer>
            </div>
          );
        };


        // ===== PERMISSION MODAL =====
        const PermissionModal = ({ onClose, onGranted }) => {
            const [requesting, setRequesting] = useState(false);

            const handleRequestAll = async () => {
                setRequesting(true);
                const results = await PermissionManager.requestAll();
                setRequesting(false);
                onGranted(results);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 animate-in">
                    <div className="bg-white rounded-2xl p-6 max-w-md w-full animate-pop shadow-2xl">
                        <h2 className="text-2xl font-bold mb-4 text-center">ðŸ” Permissions Needed</h2>
                        <p className="text-gray-600 mb-6 text-center">VibeVault needs your permission to:</p>
                        
                        <div className="space-y-3 mb-6">
                            <div className="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                                <span className="text-2xl">ðŸ“</span>
                                <div>
                                    <div className="font-semibold text-sm">Location</div>
                                    <div className="text-xs text-gray-600">Track where you\'ve been</div>
                                </div>
                            </div>
                            
                            <div className="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                                <span className="text-2xl">ðŸŽ¤</span>
                                <div>
                                    <div className="font-semibold text-sm">Microphone</div>
                                    <div className="text-xs text-gray-600">Voice journaling</div>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 px-4 py-3 bg-gray-100 rounded-lg font-semibold hover:bg-gray-200">Later</button>
                            <button onClick={handleRequestAll} disabled={requesting} className="flex-1 px-4 py-3 bg-gradient-to-r from-indigo-500 to-pink-500 text-white rounded-lg font-semibold disabled:opacity-50">
                                {requesting ? 'Requesting...' : 'Grant Access'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== INSTALL PROMPT =====
        const InstallPrompt = ({ onInstall, onDismiss }) => {
            return (
                <div className="fixed bottom-20 left-4 right-4 bg-white rounded-2xl shadow-2xl p-4 z-40 animate-slide-up border-2 border-indigo-200">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-pink-500 rounded-xl flex items-center justify-center text-2xl">âš¡</div>
                        <div className="flex-1">
                            <div className="font-bold text-sm">Install VibeVault</div>
                            <div className="text-xs text-gray-600">Quick access from home screen</div>
                        </div>
                        <button onClick={onInstall} className="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-semibold hover:bg-indigo-600">Install</button>
                        <button onClick={onDismiss} className="text-gray-400 hover:text-gray-600">âœ•</button>
                    </div>
                </div>
            );
        };

        const App = () => {
          const [user, setUser] = useState(null);
          const [isLocked, setIsLocked] = useState(() => {
              // Check if PIN is set on app load
              return localStorage.getItem('vibevault_pin_hash') !== null;
          });
          const [showPermissionModal, setShowPermissionModal] = useState(false);
          const [showInstallPrompt, setShowInstallPrompt] = useState(false);
          const [permissionsGranted, setPermissionsGranted] = useState({ location: false, microphone: false });
          const [userProfile, setUserProfile] = useState(null);
          const [currentView, setCurrentView] = useState('landing'); 
          const [dailyStatus, setDailyStatus] = useState(null);
          const [counts, setCounts] = useState({ movies: 0, songs: 0, travel: 0, locations: 0 });
          const [stats, setStats] = useState(null);
          const [showDataModal, setShowDataModal] = useState(false);
          const [streak, setStreak] = useState(0); 
          
          const { saveData, subscribeToData, clearData, exportData, importData } = useDataPersistence();
          const activeConfig = useMemo(() => {
              const lang = userProfile?.language || 'en';
              const defaults = getTrackerConfigs(lang);
              return userProfile?.customLabels ? { ...defaults, ...userProfile.customLabels } : defaults; 
          }, [userProfile]);

          // --- DEFINE HANDLERS BEFORE USE-EFFECTS TO ENSURE SCOPE SAFETY ---
          
          const handleSaveWizard = async (wizardData) => {
              if (!user) return;
              const today = new Date();
              const year = today.getFullYear();
              const todayKey = `${today.getMonth()}-${today.getDate()}`;
              const weekNumber = getWeekNumber(today);
              const weekKey = `week-${weekNumber}`;

              // 1. Save Mood to Rate My Day tracker
              if (wizardData.mood) {
                  const currentRateData = (await new Promise(r => { const u = subscribeToData(user.uid, 'tracker_data', `rateMyDay_${year}`, (d) => { r(d?.grid || {}); u(); }); }));
                  await saveData(user.uid, 'tracker_data', `rateMyDay_${year}`, { grid: { ...currentRateData, [todayKey]: wizardData.mood } });
              }
              
              // 2. Save Emotion to Emotions tracker
              if (wizardData.emotion) {
                  const currentEmotionData = (await new Promise(r => { const u = subscribeToData(user.uid, 'tracker_data', `emotions_${year}`, (d) => { r(d?.grid || {}); u(); }); }));
                  await saveData(user.uid, 'tracker_data', `emotions_${year}`, { grid: { ...currentEmotionData, [todayKey]: wizardData.emotion } });
              }
              
              // 3. Save Anxiety to Anxiety tracker
              if (wizardData.anxiety) {
                  const currentAnxietyData = (await new Promise(r => { const u = subscribeToData(user.uid, 'tracker_data', `anxiety_${year}`, (d) => { r(d?.grid || {}); u(); }); }));
                  await saveData(user.uid, 'tracker_data', `anxiety_${year}`, { grid: { ...currentAnxietyData, [todayKey]: wizardData.anxiety } });
              }
              
              // 4. Save Weather factors to Weather tracker (if any)
              if (wizardData.factors && wizardData.factors.length > 0) {
                  // Filter weather factors (check against weather levels)
                  const weatherFactorValues = activeConfig.weather.levels.map(l => l.value);
                  const weatherFactors = wizardData.factors.filter(f => weatherFactorValues.includes(f));
                  
                  if (weatherFactors.length > 0) {
                      const currentWeatherData = (await new Promise(r => { const u = subscribeToData(user.uid, 'tracker_data', `weather_${year}`, (d) => { r(d?.grid || {}); u(); }); }));
                      // Save all weather factors for today (comma-separated or array)
                      await saveData(user.uid, 'tracker_data', `weather_${year}`, { grid: { ...currentWeatherData, [todayKey]: weatherFactors.join(',') } });
                  }
                  
                  // Filter health factors
                  const healthFactorValues = activeConfig.health.levels.map(l => l.value);
                  const healthFactors = wizardData.factors.filter(f => healthFactorValues.includes(f));
                  
                  if (healthFactors.length > 0) {
                      const currentHealthData = (await new Promise(r => { const u = subscribeToData(user.uid, 'tracker_data', `health_${year}`, (d) => { r(d?.grid || {}); u(); }); }));
                      await saveData(user.uid, 'tracker_data', `health_${year}`, { grid: { ...currentHealthData, [todayKey]: healthFactors.join(',') } });
                  }
              }
              
              // 5. Save ONLY the note text to Weekly Moments (no factors!)
              if (wizardData.note && wizardData.note.trim()) {
                  const currentNotes = (await new Promise(r => { const u = subscribeToData(user.uid, 'tracker_data', `weekly_moments_${year}`, (d) => { r(d?.notes || {}); u(); }); }));
                  const newEntry = { id: generateId(), text: wizardData.note.trim(), timestamp: Date.now() };
                  
                  const weekEntries = currentNotes[weekKey] || [];
                  await saveData(user.uid, 'tracker_data', `weekly_moments_${year}`, { notes: { ...currentNotes, [weekKey]: [...weekEntries, newEntry] } });
              }
              
              alert("Entry Saved! âœ…\n\nMood, emotion, anxiety, and factors saved to their trackers.\nNote saved to Weekly Best Moments.");
              window.location.reload(); 
          };

          const handleExport = async () => {
              if (!user) return;
              const data = await exportData(user.uid);
              const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
              const downloadAnchorNode = document.createElement('a');
              downloadAnchorNode.setAttribute("href", dataStr);
              downloadAnchorNode.setAttribute("download", "vibevault_backup.json");
              document.body.appendChild(downloadAnchorNode);
              downloadAnchorNode.click();
              downloadAnchorNode.remove();
          };

          const handleImport = async (file) => {
              const reader = new FileReader();
              reader.onload = async (e) => {
                  try {
                      const json = JSON.parse(e.target.result);
                      if (user) {
                          const success = await importData(user.uid, json);
                          if (success) { alert(TRANSLATIONS[userProfile?.language || 'en'].importSuccess); window.location.reload(); }
                          else { alert("Import failed: Not supported in cloud mode yet."); }
                      }
                  } catch (err) { console.error("Import error", err); alert("Invalid JSON file."); }
              };
              reader.readAsText(file);
          };

          useEffect(() => {
              if (userProfile && userProfile.theme && THEMES[userProfile.theme]) {
                  document.body.className = `min-h-screen selection:bg-pink-300 selection:text-pink-900 ${THEMES[userProfile.theme].bg} ${THEMES[userProfile.theme].text} ${THEMES[userProfile.theme].font}`;
              }
          }, [userProfile]);

          useEffect(() => {
            const initAuth = async () => {
                if (isLocal) { setUser({ uid: 'local-guest-user', isAnonymous: true }); return; }
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) try { await auth.signInWithCustomToken(__initial_auth_token); } catch { await auth.signInAnonymously(); } else await auth.signInAnonymously();
            };
            initAuth();
            if (!isLocal) return auth.onAuthStateChanged(setUser);
          }, []);

          useEffect(() => {
              if (user) {
                  subscribeToData(user.uid, 'profile', 'info', setUserProfile);
                  const today = new Date(), year = today.getFullYear(), todayKey = `${today.getMonth()}-${today.getDate()}`;
                  const fetchOne = (id) => new Promise(r => { const u = subscribeToData(user.uid, 'tracker_data', id, (d) => { r(d); u(); }); });
                  
                  // Daily Status & Streak Calculation
                  const dailyIds = ['rateMyDay', 'emotions', 'anxiety', 'weather', 'health'];
                  const relevantIds = dailyIds.filter(id => !userProfile?.enabledTrackers || userProfile.enabledTrackers.includes(id));
                  
                  Promise.all(relevantIds.map(id => fetchOne(`${id}_${year}`).then(d => ({ id, data: d?.grid || {} })))).then(results => {
                        setDailyStatus({ complete: results.every(r => r.data[todayKey]), missing: results.filter(r => !r.data[todayKey]).map(r => r.id) });
                        const rateData = results.find(r => r.id === 'rateMyDay')?.data;
                        let s = 0; 
                        if (rateData) {
                            const d = new Date(); 
                            if (!rateData[`${d.getMonth()}-${d.getDate()}`]) d.setDate(d.getDate() - 1);
                            while (rateData[`${d.getMonth()}-${d.getDate()}`]) { s++; d.setDate(d.getDate() - 1); }
                        }
                        setStreak(s);
                  });

                  // Stats & Counts including Travel/Location
                  Promise.all(['movies', 'songs', 'rateMyDay', 'emotions', 'travel', 'locations'].map(id => fetchOne(`${id}_${year}`).then(d => ({ id, data: d })))).then(results => {
                      const c = { movies: 0, songs: 0, travel: 0, locations: 0 }; 
                      const s = { rateMyDay: {}, emotions: {} };
                      results.forEach(({ id, data }) => {
                          if (id === 'movies' || id === 'songs') Object.values(data?.notes || {}).forEach(v => c[id] += Array.isArray(v) ? v.length : 1);
                          else if (id === 'travel') Object.values(data?.notes || {}).forEach(v => c[id] += Array.isArray(v) ? v.length : 0);
                          else if (id === 'locations') c[id] = Object.keys(data || {}).length;
                          else if (['rateMyDay', 'emotions'].includes(id)) Object.values(data?.grid || {}).forEach(v => s[id][v] = (s[id][v] || 0) + 1);
                      });
                      setCounts(c); setStats(s);
                  });
              }
          }, [user, currentView, userProfile]);



          // Show permission modal on first visit
          useEffect(() => {
              if (userProfile && !localStorage.getItem('permissionsAsked')) {
                  setTimeout(() => {
                      setShowPermissionModal(true);
                      localStorage.setItem('permissionsAsked', 'true');
                  }, 1000);
              }
          }, [userProfile]);

          // Check for install prompt
          useEffect(() => {
              const checkInstall = () => {
                  if (window.showInstallPromotion && !localStorage.getItem('installDismissed')) {
                      setShowInstallPrompt(true);
                  }
              };
              setTimeout(checkInstall, 2000);
          }, []);

          const handlePermissionsGranted = (results) => {
              setPermissionsGranted(results);
          };

          const handleInstall = async () => {
              if (window.installPWA) await window.installPWA();
              setShowInstallPrompt(false);
          };

          const handleDismissInstall = () => {
              setShowInstallPrompt(false);
              localStorage.setItem('installDismissed', 'true');
          };

          const t = TRANSLATIONS[userProfile?.language || 'en'];
          const theme = THEMES[userProfile?.theme || 'playful'];
          
          // Show PIN lock if locked
          if (isLocked) {
              return <PinLockScreen onUnlock={() => setIsLocked(false)} theme={theme} t={t} />;
          }

          return (
            <div className={`font-sans ${theme.text}`}>
                {currentView === 'landing' ? (
                    <>
                        <LandingPage 
                            onNavigate={setCurrentView} 
                            userProfile={userProfile} 
                            onUpdateProfile={(d) => { saveData(user.uid, 'profile', 'info', d); setUserProfile(d); }} 
                            onResetAll={() => confirm(t.resetConfirm) && clearData(user.uid, 'all') && window.location.reload()} 
                            t={t} 
                            dailyStatus={dailyStatus} 
                            activeConfig={activeConfig} 
                            counts={counts} 
                            stats={stats} 
                            theme={theme} 
                            streak={streak} 
                            onExport={handleExport} 
                            onImport={handleImport}
                            onSaveWizard={handleSaveWizard}
                        />
                        {showDataModal && <DataModal onClose={() => setShowDataModal(false)} t={t} onExport={handleExport} onImport={handleImport} />}
                        <div className="fixed bottom-4 left-4 z-50"><button onClick={() => setShowDataModal(true)} className="flex items-center gap-2 px-3 py-1.5 bg-blue-100/80 hover:bg-blue-200 text-blue-700 rounded-full text-[10px] font-bold uppercase tracking-wider backdrop-blur-sm border border-blue-200/50 shadow-sm"><IconDownload className="w-3 h-3" /> Data</button></div>
                    </>
                ) : <TrackerController trackerId={currentView} onNavigate={setCurrentView} user={user} t={t} activeConfig={activeConfig} userProfile={userProfile} onUpdateProfile={(d) => { saveData(user.uid, 'profile', 'info', d); setUserProfile(d); }} />}
                 
                 {showPermissionModal && (
                     <PermissionModal 
                         onClose={() => setShowPermissionModal(false)}
                         onGranted={handlePermissionsGranted}
                     />
                 )}
                 
                 {showInstallPrompt && (
                     <InstallPrompt 
                         onInstall={handleInstall}
                         onDismiss={handleDismissInstall}
                     />
                 )}
            </div>
          );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>